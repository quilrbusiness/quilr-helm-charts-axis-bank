id: 1a4ae431-8c70-4df4-83ca-eb635c2a0a30
name: Compromised Password Resolution
type: rule
version: 5.2
schedule: 2m
historicalrecordduration: 2m
active: false
source:
  type: query
  config:
    query: "MATCH (u:USER {subscriber: $subscriber, tenant: $tenant})-[]-(e:EMAIL)-[]-(acc:ACCOUNT)-[]-(finding {id: $findingId})-[]-(r:RULE)-[]-(b:BEHAVIOR {id: 'BID_08'})
            WHERE finding.status <> 'closed'
            MATCH (user:USER) - [has_email:HAS_EMAIL] - (email:EMAIL:PRIMARY)-[credsbased_account:CREDSBASED_ACCOUNT]-(account:ACCOUNT)-[using_app:USING_APP] - (app:APPLICATION),
              (account:ACCOUNT)-[has_cred_fingerprint:HAS_CRED_FINGERPRINT] - (cred_fingerprint:CRED_FINGERPRINT),
              (app) - [has_app_category:HAS_APP_CATEGORY] - (app_category:APP_CATEGORY)
            OPTIONAL MATCH (tenant:TENANT)-[app_settings:HAS_APP_SETTINGS]-(app) 
            OPTIONAL MATCH (account:ACCOUNT)-[using_browser:HAS_BROWSER] - (browser:BROWSER)
            OPTIONAL MATCH (user)-[:BELONGS_TO]->(group:GROUP {userDefined: true})
            OPTIONAL MATCH (user)-[:HAS_DEPARTMENT]->(department:DEPARTMENT)
            WITH user,has_email,email,credsbased_account,account,using_app,app,app_settings,tenant,has_cred_fingerprint,cred_fingerprint,app_category,browser
            WHERE credsbased_account.timestamp >= $starttime
                AND credsbased_account.timestamp <= $endtime
                AND cred_fingerprint.compromised_password_status = false
                AND finding.status <> 'closed'
            RETURN DISTINCT
                user.id AS userId,
                user.displayName AS userName,
                user.mail AS userMail,
                user.accountEnabled as userAccountEnabled,
                user.tenant as TENANT,               
                user.subscriber AS SUBSCRIBER,
                app.id_ as appId,
                app.name AS appName,
                app.Url AS appUrl,
                COLLECT(app_category.name) AS appCategory,
                account.compromised_password_source AS compromisedPasswordSource,
                COALESCE(app_settings.criticality, app.criticality, 'NOT SET') AS appCriticality, 
                user.mail+'_'+app.id_ AS userAppAccount, 
                browser.id as browserUsed,
                cred_fingerprint.id as credFingerprintId,
                cred_fingerprint.password_strength as passwordStrength, 
                app.domain AS appDomain,
                credsbased_account.context_id as CONTEXTID, 
                has_cred_fingerprint.last_access_time as EVENTTIME"
    type: knowledgegraph 
    limit:
    offset: 0
destination:
  type: stream 
  topic: ruleEvaluator
config:
  expression: "def fn(message): return True if message.get('userName') else False " 
  type: resolution
  subtype: status
  code: Q001
  entity: userName
  entitytype: user
  template: "User: ${userName} password strength on Application: ${appName} is strong"
  properties: {}
  artifacts:
    - type: "CRED_FINGERPRINNT"
      property: id
      value: "$credFingerprintId"
      artifactproperties: 
        artifactValue: $passwordStrength
        displayInUI: disabled
lambda: ""
createdon: 1720396800
updatedon: 1720396800