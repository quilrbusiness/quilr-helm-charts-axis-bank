id: 6ef9aa3b-053c-42e8-8dae-5fde229689b6
name: Credential Sharing Resolution
type: rule
version: 3.2
schedule: 2m
historicalrecordduration: 2m
active: false
source:
  type: query
  config:
    query: "MATCH (user1:USER)-[has_email1:HAS_EMAIL]-(email1:EMAIL:PRIMARY),
          (email1)-[credsbased_account1:CREDSBASED_ACCOUNT]-(account1:ACCOUNT),
          (account1)-[using_app:USING_APP]-(app:APPLICATION),
          (account1:ACCOUNT)-[credential_shared:CREDENTIAL_SHARED]->(account:ACCOUNT),
          (account)-[credsbased_account:CREDSBASED_ACCOUNT]-(email:EMAIL),
          (email)-[has_email:HAS_EMAIL]-(user:USER),
          (app) - [has_app_category:HAS_APP_CATEGORY] - (app_category:APP_CATEGORY)
          OPTIONAL MATCH (tenant:TENANT)-[app_settings:HAS_APP_SETTINGS]-(app) 
          OPTIONAL MATCH (account:ACCOUNT)-[using_browser:HAS_BROWSER] - (browser:BROWSER)
          OPTIONAL MATCH (user)-[:BELONGS_TO]->(group:GROUP {userDefined: true})
          OPTIONAL MATCH (user)-[:HAS_DEPARTMENT]->(department:DEPARTMENT)
          WITH user1,has_email1,email1,credsbased_account1,account1,using_app,app,credential_shared,email,has_email,user,account,app_category,app_settings,credsbased_account
          WHERE credential_shared.to IS NULL
                  AND account.email <> account1.email
                  AND credential_shared.from >= $starttime
                  AND credential_shared.from <= $endtime
          WITH user1,has_email1,email1,credsbased_account1,account1,using_app,app,credential_shared,email,has_email,user,account,app_category,app_settings,credsbased_account
          RETURN DISTINCT
              user.displayName AS userName,
              user1.displayName AS userName1,
              user.mail AS userMail,
              user.accountEnabled as userAccountEnabled,
              user.tenant as TENANT,
              user.subscriber AS SUBSCRIBER,
              app.id_ as appId,
              app.name AS appName,
              app.Url AS appUrl,
              app.domain AS appDomain,
              account.email AS email,
              COLLECT(app_category.name) AS appCategory,
              COALESCE(app_settings.criticality, app.criticality, 'NOT SET') AS appCriticality, 
              account1.email AS email1,
              user.mail+'_'+app.id_ AS userAppAccount,
              user1.mail+'_'+app.id_ AS userAppAccount1,
              credsbased_account.context_id as CONTEXTID"
    type: knowledgegraph 
    limit:
    offset: 0
destination:
  type: stream 
  topic: ruleEvaluator
config:
  expression: "def fn(message): return True if message.get('userName') else False " 
  type: resolution
  subtype: status
  code: Q002
  entity: userName
  entitytype: user
  template: "User: ${userName} password strength on Application: ${appName} is strong"
  properties: {}
  artifacts:
    - type: "CRED_FINGERPRINNT"
      property: id
      value: "$credFingerprintId"
      artifactproperties: 
        artifactValue: $passwordStrength
        displayInUI: disabled
lambda: ""
createdon: 1720396800
updatedon: 1720396800