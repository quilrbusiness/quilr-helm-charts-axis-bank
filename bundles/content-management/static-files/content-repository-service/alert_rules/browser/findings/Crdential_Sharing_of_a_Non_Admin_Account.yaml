id: e85275f9-01fa-4058-8400-22243429b30a  #UUID - 36 chars
name: Credential Sharing of a Non Admin Account
type: rule  #rule configs - type rule only
version: 2.1
active: false
schedule: "10m" 
historicalrecordduration: "10m"
source:
  type: query
  config:
    query: "MATCH (user1:USER)-[has_email1:HAS_EMAIL]-(email1:EMAIL:PRIMARY),
                  (email1)-[credsbased_account1:CREDSBASED_ACCOUNT]-(account1:ACCOUNT),
                  (account1)-[using_app:USING_APP]-(app:APPLICATION),
                  (account1:ACCOUNT)-[credential_shared:CREDENTIAL_SHARED]->(account:ACCOUNT),
                  (account)-[credsbased_account:CREDSBASED_ACCOUNT]-(email:EMAIL),
                  (email)-[has_email:HAS_EMAIL]-(user:USER)
              WHERE credential_shared.to IS NULL
                    AND account.email <> account1.email
                    AND NOT EXISTS {
                      MATCH (user)-[:BELONGS_TO]->(:GROUP {displayName: 'Admins'})
                    }
                    AND credential_shared.from >= $starttime
                    AND credential_shared.from <= $endtime
              WITH user, user1, account, account1, app, credsbased_account, credential_shared
              OPTIONAL MATCH (account)-[using_browser:HAS_BROWSER]-(browser:BROWSER)
              OPTIONAL MATCH (account:ACCOUNT)-[has_cred_fingerprint:HAS_CRED_FINGERPRINT]-(cred_fingerprint:CRED_FINGERPRINT)
              OPTIONAL MATCH (user)-[has_department:HAS_DEPARTMENT]-(department:DEPARTMENT)
              OPTIONAL MATCH (app)-[has_app_category:HAS_APP_CATEGORY]-(app_category:APP_CATEGORY)
              RETURN DISTINCT
                user.id AS userId,
                user.displayName AS userName,
                user1.displayName AS userName1,
                user.mail AS userMail,
                user.accountEnabled as userAccountEnabled,
                department.name as userDepartment,
                user.tenant as TENANT,
                user.subscriber AS SUBSCRIBER,
                app.id_ as appId,
                app.name AS appName,
                app.Url AS appUrl,
                app.domain AS appDomain,
                account.email AS email,
                account1.email AS email1,
                COLLECT(app_category.name) AS appCategory,
                user.mail+'_'+app.id_ AS userAppAccount,
                user1.mail+'_'+app.id_ AS userAppAccount1,
                browser.id as browserUsed,
                using_browser.client_ip as ipaddress,
                credsbased_account.context_id as CONTEXTID,
                credential_shared.last_access_time as EVENTTIME"
    type: knowledgegraph 
    limit:
    offset: 0
destination:
  type: stream 
  topic: ruleEvaluator
config:
  expression: "def fn(message): return True if message.get('userName') else False " 
  type: finding
  subtype: status
  code: Q028
  status: open
  sla: 1W
  entity: userName
  entitytype: user
  tags:
    - insecure_behaviour
  sourceofalert: Quilr 
  template: "Received an alert for the User: ${userName} on Application: ${appName}"
  artifacts: 
    - type: "ACCOUNT"
      property: "id"
      value: "$userAppAccount"
      artifactproperties: 
        artifactValue: $userName
        displayInUI: enabled
        artifactKey: "Admin Credential Shared By"

    - type: "ACCOUNT"
      property: "id"
      value: "$userAppAccount1"
      artifactproperties: 
        artifactValue: $userName1
        displayInUI: enabled
        artifactKey: "Credential Used By"

    - type: "APPLICATION" 
      context: "global" 
      property: id_
      value: $appId
      artifactproperties: 
        artifactValue: $appName
        displayInUI: enabled
        artifactKey: "Application"

    - type: "IPADDRESS"
      property: "id"
      value: "$ipaddress"
      artifactproperties: 
        artifactValue: $ipaddress
        displayInUI: enabled
        artifactKey: "IP Address"
  properties:
    userId: $userId  #FORMAT - findingattribute: variable from the top of this YAML
    userName: $userName
    userMail: $userMail
    userAccountEnabled: $userAccountEnabled
    userDepartment: $userDepartment
    TENANT: $TENANT
    SUBSCRIBER: $SUBSCRIBER
    appName: $appName
    appUrl: $appUrl
    appId: $appId
    appCategory: $appCategory 
    appDomain: $appDomain
    browser: $browserUsed
    context_id: $CONTEXTID
    eventtime: $EVENTTIME
lambda: ""
createdon: 1720396800000
updatedon: 1720396800000