id: 8e30b153-0b3e-4af1-9243-3ccc178fd0ec
name: Login with Weak Password on Critical Apps
type: rule
version: 2.1
active: false
schedule: 2m
historicalrecordduration: 2m
source:
  type: query
  config:
    query: "MATCH (user:USER)-[has_email:HAS_EMAIL]-(email:EMAIL:PRIMARY),
                  (email)-[credsbased_account:CREDSBASED_ACCOUNT]-(account:ACCOUNT),
                  (account)-[using_app:USING_APP]-(app:APPLICATION),
                  (account:ACCOUNT)-[has_cred_fingerprint:HAS_CRED_FINGERPRINT]-(cred_fingerprint:CRED_FINGERPRINT)
            OPTIONAL MATCH (tenant:TENANT)-[app_settings:HAS_APP_SETTINGS]-(app) 
            WHERE tolower(app_settings.criticality) = 'critical'
            WITH user,has_email,email,credsbased_account,account,using_app,app,has_cred_fingerprint,cred_fingerprint,app_settings
            WHERE tolower(COALESCE(app_settings.criticality, app.criticality, 'NOT SET')) = 'critical'
                  AND cred_fingerprint.compromised_password_status = false
                  AND cred_fingerprint.password_strength in [0, 1, 2]
                  AND has_cred_fingerprint.to IS NULL
                  AND has_cred_fingerprint.from IS NOT NULL
                  AND has_cred_fingerprint.from >= $starttime
                  AND has_cred_fingerprint.from <= $endtime
            OPTIONAL MATCH (account:ACCOUNT)-[using_browser:HAS_BROWSER]-(browser:BROWSER),
                          (user)-[has_department:HAS_DEPARTMENT]-(department:DEPARTMENT),
                          (app)-[has_app_category:HAS_APP_CATEGORY]-(app_category:APP_CATEGORY)
            RETURN DISTINCT
                user.id AS userId,
                user.displayName AS userName,
                user.mail AS userMail,
                user.accountEnabled AS userAccountEnabled,
                department.name AS userDepartment,
                user.tenant AS TENANT,               
                user.subscriber AS SUBSCRIBER,
                app.id_ AS appId,
                app.name AS appName,
                app.domain AS appDomain,
                app.logoUrl AS appLogoUrl,
                app.url AS appUrl,
                COLLECT(DISTINCT app_category.name) AS appCategories,
                COALESCE(app_settings.criticality, app.criticality, 'NOT SET') AS appCriticality,
                cred_fingerprint.id AS credFingerprintId,
                user.mail + '_' + app.id_ AS userAppAccount, 
                browser.id as browserUsed,
                cred_fingerprint.password_strength as passwordStrength, 
                using_browser.client_ip as ipaddress,
                has_cred_fingerprint.context_id as CONTEXTID,
                has_cred_fingerprint.last_access_time as EVENTTIME"
    type: knowledgegraph 
    limit:
    offset: 0
destination:
  type: stream 
  topic: ruleEvaluator
config:
  expression: "def fn(message): return True if message.get('userName') else False " 
  type: finding
  subtype: status
  code: Q002
  sla: 1W
  entity: userName
  entitytype: user
  tags:
    - insecure_behaviour
  sourceofalert: Quilr 
  template: "Received an alert for the User: ${userName} on Application: ${appName}"
  artifacts: 
    - type: ACCOUNT
      property: id
      value: $userAppAccount
      artifactproperties: 
        artifactValue: $userName
        displayInUI: enabled

    - type: APPLICATION
      property: id_
      value: $appId
      context: global
      artifactproperties: 
        artifactValue: $appName
        displayInUI: enabled

    - type: IPADDRESS
      property: id
      value: $ipaddress
      artifactproperties: 
        artifactValue: $ipaddress
        displayInUI: enabled

    - type: CRED_FINGERPRINT
      property: id
      value: $credFingerprintId
      artifactproperties: 
        artifactValue: $passwordStrength	
        displayInUI: disabled
  properties:
    userId: $userId
    userName: $userName
    userMail: $userMail
    userAccountEnabled: $userAccountEnabled
    userDepartment: $userDepartment
    TENANT: $TENANT
    SUBSCRIBER: $SUBSCRIBER
    appId: $appId
    appName: $appName
    appDomain: $appDomain
    appUrl: $appUrl
    appLogoUrl: $appLogoUrl
    appCriticality: $appCriticality
    appCategories: $appCategories
    credFingerprintId: $credFingerprintId
    passwordStrength: $passwordStrength
    browser: $browserUsed
    context_id: $CONTEXTID
    time: $EVENTTIME
lambda: ""
createdon: 1720396800
updatedon: 1720396800