id: be2d0f0f-41ad-45d4-a1a0-3fcb8af9468a  #UUID - 36 chars
name: Login using OAuth Based Account with High Risk Scopes to Unverified SaaS App 
type: rule  #rule configs - type rule only
version: 2.1
active: false
schedule: "10m" 
historicalrecordduration: "10m"
source:
  type: query
  config:
    query: "WITH date(datetime({epochSeconds:  timestamp()/1000})) AS current_date
            MATCH (user:USER) - [has_email:HAS_EMAIL] - (email:EMAIL:PRIMARY)-[oauth_acc:OAUTH_ACCOUNT]-(account:ACCOUNT),
                  (account:ACCOUNT)-[using_app:USING_APP]-(app:APPLICATION)-[has_grant:HAS_GRANT]-(grant:GRANT)-[has_scope:HAS_SCOPE]-(scope:SCOPE)
            OPTIONAL MATCH (tenant:TENANT)-[app_settings:HAS_APP_SETTINGS]-(app)
            OPTIONAL MATCH (app) - [has_app_category:HAS_APP_CATEGORY] - (app_category:APP_CATEGORY)
            WHERE app_settings.isVerified = false
            WITH user,has_email,email,oauth_acc,account,using_app,app,app_settings,tenant,has_grant,grant,has_scope,scope
            WHERE oauth_acc.timestamp >= $starttime
                AND oauth_acc.timestamp <= $endtime
                AND toupper(scope.severity) = 'HIGH'
            RETURN DISTINCT
                user.id AS userId,
                user.displayName AS userName,
                user.mail AS userMail,
                user.accountEnabled as userAccountEnabled,
                user.tenant as TENANT,               
                user.subscriber AS SUBSCRIBER,
                app.id_ as appId,
                app.name AS appName,
                app.domain AS appDomain,
                COLLECT(app_category.name) AS appCategory,
                app.Url AS appUrl,
                COLLECT(scope.id) AS scope,
                grant.consentBy AS consentBy,
                user.mail+'_'+app.id_ AS userAppAccount"
    type: knowledgegraph 
    limit:
    offset: 0
destination:
  type: stream 
  topic: ruleEvaluator
config:
  expression: "def fn(message): return True if message.get('userName') else False " 
  type: finding
  subtype: status
  code: Q050
   050
  status: open
  sla: 1W
  entity: userName
  entitytype: user
  tags:
    - insecure_behaviour
  sourceofalert: Quilr 
  template: "Received an alert for the User: ${userName} on Application: ${appName}"
  artifacts: 
     - type: "ACCOUNT"
       property: "id"
       value: "$userAppAccount"
       artifactproperties: 
        artifactValue: $userName
        displayInUI: enabled
        artifactKey: "Account"

     - type: "APPLICATION" 
       context: "global" 
       property: id_
       value: $appId
       artifactproperties: 
        artifactValue: $appName
        displayInUI: enabled
        artifactKey: "Application"

     - type: "SCOPE"
       property: "id"
       value: "$scope"
       artifactproperties: 
        artifactValue: $scope
        displayInUI: enabled
        artifactKey: "Scope Used"
  properties:
    userId: $userId  #FORMAT - findingattribute: variable from the top of this YAML
    userName: $userName
    userMail: $userMail
    userAccountEnabled: $userAccountEnabled
    TENANT: $TENANT
    SUBSCRIBER: $SUBSCRIBER
    appName: $appName
    appUrl: $appUrl
    appId: $appId
    appCategory: $appCategory 
    scope: $scope
    consentBy: $consentBy
    appDomain: $appDomain
lambda: ""
createdon: 1720396800000
updatedon: 1720396800000