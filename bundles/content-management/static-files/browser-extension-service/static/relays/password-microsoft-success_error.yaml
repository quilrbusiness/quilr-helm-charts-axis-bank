name: password-microsoft-success_error
version: 1.0.0
sequences:
  - name: is-request-error
    waiton: []
    ifnext:
      name: clear_chained
      waiton: [is-request-error]
      next:
        - name: END
    elsenext:
      name: is-login
      waiton: [is-request-error]
      next:
        - name: get-email
          waiton: [is-login]
          next:
        - name: get-password
          waiton: [is-login]
          next:
            - name: hash_password
              waiton: [get-password]
              next:
                - name: save-credentials
                  waiton: [hash_password]
                  next:
                    - name: get-saved-credentials
                      waiton: [hash_password]
                      next:
                        - name: get-credential-reused
                          waiton: [get-saved-credentials]
                          next:
                            - name: get-password-manager
                              waiton: [is-login]
                              next: []
                            - name: get-password-compromised
                              waiton: []
                              next: []
                            - name: get-password-strength
                              waiton: []
                              next: []
                            - name: send_log_event
                              waiton:
                                [
                                  get-saved-credentials,
                                  get-credential-reused,
                                  get-password-manager,
                                  get-password-compromised,
                                  get-password-strength,
                                ]
                              next:
                                - name: join_end
                                  waiton: [send_log_event]
                                  next:
                                    - name: get-check-ids
                                      waiton: [join_end]
                                      next:
                                        - name: check-findings
                                          waiton: [get-check-ids]
                                          next:
                                            - name: process-notifications
                                              waiton: [check-findings]
                                              next:
                                                - name: should_send_notification
                                                  waiton:
                                                    [process-notifications]
                                                  ifnext:
                                                    name: show-notification
                                                    waiton:
                                                      [should_send_notification]
                                                    next:
                                                      - name: END
                                                  elsenext:
                                                    name: END

actions:
  - name: is_shared_credential
    type: effect
    config:
      command: chained && chained[data.basket.requestObject.tabId + 'password-checker-form'] && chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['is_credential_shared'].response.data
  - name: is_password_weak
    type: condition_eval
    config:
      condition: "data.outcome.outcomes['get-password-strength'].response.data.score < 3"
  - name: get-password-strength
    type: effect
    config:
      command: chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['check-password-strength'].response.data.score
  - name: get-email
    type: effect
    config:
      command: "chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['get-email-value'].response.data"
  - name: get-password
    type: effect
    config:
      command: chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['get-password'].response.data
  - name: get-saved-credentials
    type: effect
    config:
      command: "chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['get-saved-credentials'].response.data.filter(e => e.domain !== stripUrl(data.basket.requestObject.initiator)).map(e => ({id: e.id, domain: e.domain}))"
  - name: get-credential-reused
    type: effect
    config:
      command: "Array.isArray(data.outcome.outcomes['get-saved-credentials'].response.data) && data.outcome.outcomes['get-saved-credentials'].response.data.length > 0 ? {status: true, details: data.outcome.outcomes['get-saved-credentials'].response.data.map(e => ({ domain: e.domain, email: e.id })) } : { status: false }"
  - name: get-password-manager
    type: effect
    config:
      command: "chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['password-manager-used'].response.data"
  - name: hash_password
    type: hash
    config:
      params: data.outcome.outcomes['get-password'].response.data
  - name: save-credentials
    type: save_hash
    config:
      email: "data.outcome.outcomes['get-email'].response.data.email"
      password: "data.outcome.outcomes['hash_password'].response.data"
      domain: "chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['make-check-ob'].response.data.url"
      isIdp: "chained[data.basket.requestObject.tabId +'app-criticality-checker'].outcomes['is-idp-sso'].response.data"
      isCritical: "chained[data.basket.requestObject.tabId +'app-criticality-checker'].outcomes['is-app-critical'].response.data"
      appName: "chained[data.basket.requestObject.tabId +'app-criticality-checker'].outcomes['app-name'].response.data"
  - name: get-password-compromised
    type: effect
    config:
      command: "chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['is_password_compromised'].response.data ? JSON.parse(JSON.stringify({ status: true, source: 'hibp'})): JSON.parse(JSON.stringify({status: false}))"
  - name: send_log_event
    type: send_logs
    config:
      args: "JSON.parse(JSON.stringify({
        check: {
        id: 'CID_16',
        name: 'login',
        properties: {
        cred_fingerprint_id: chained && chained[data.basket.requestObject.tabId + 'password-checker-form'] && chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['make-check-ob'].response.data ? chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['make-check-ob'].response.data.check.properties.cred_fingerprint_id : '',
        context_id: chained && chained[data.basket.requestObject.tabId+'password-checker-form'].outcomes['join_end'].response.data.context_id ? chained[data.basket.requestObject.tabId+'password-checker-form'].outcomes['join_end'].response.data.context_id : crypto.randomUUID(),
        signup: data.outcome.outcomes['is-login'].response.data ? false: true,
        credentials: data.outcome.outcomes['get-email'].response.data,
        credential_shared: chained && chained[data.basket.requestObject.tabId+'credential-sharing'] && chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes['join_end'].response.data && chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes['join_end'].response.data.credential_shared.data ? { status: true } : { status: false },
        password_strength: data.outcome.outcomes['get-password-strength'].response.data,
        compromised_password: data.outcome.outcomes['get-password-compromised'].response.data,
        credential_reused: data.outcome.outcomes['get-credential-reused'].response.data,
        using_password_manager: data.outcome.outcomes['get-password-manager'].response.data,
        mfatype: '',
        mfastrength: '',
        be_mfa_enabled: false,
        },
        },
        url: chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['make-check-ob'].response.data.url,
        title: chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['make-check-ob'].response.data.title
        }))"
      check_mfa: true
  - name: is-login
    type: effect
    config:
      command: "chained[data.basket.requestObject.tabId + 'password-checker-form'] && chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['check_login_signup'].response.data === 'Signup' ? false : true"
  - name: is-request-error
    type: condition_eval
    config:
      condition: data.basket.requestObject.statusCode >= 400 || data.basket.requestObject.responseHeaders.some(e => e.value.startsWith('ESTSAUTHLIGHT=+') && e.value.slice(e.value.indexOf('ESTSAUTHLIGHT=+') + 15, e.value.indexOf(';')).length === 0)
  - name: is-request-success
    type: condition_eval
    config:
      condition: data.basket.requestObject.statusCode >= 200 && data.basket.requestObject.statusCode < 300 && data.basket.requestObject.responseHeaders.some(e => e.value.startsWith('ESTSAUTHLIGHT=+') && e.value.slice(e.value.indexOf('ESTSAUTHLIGHT=+') + 15, e.value.indexOf(';')))
  - name: check-if-request-in-chain
    type: effect
    config:
      command: "'https://login.microsoftonline.com/common/login'.trim()"
  - name: is-request-url
    type: condition_eval
    config:
      condition: data.outcome.outcomes['check-if-request-in-chain'].response.data === data.basket.requestObject.url
  - name: clear_chained
    type: remove_chain
    config:
      args:
        [
          "password-checker-before",
          "password-checker-form",
          "credential-sharing",
          "app-criticality-checker",
        ]
  - name: join_end
    type: effect
    config:
      command: "JSON.parse(JSON.stringify({
        isAdmin: persona && persona.details && persona.details.isAdmin ? { checkId: 'CH-FORM-ADMIN' } : {},
        isAdminCredentials: chained && chained[data.basket.requestObject.tabId + 'credential-sharing']
        && chained[data.basket.requestObject.tabId + 'credential-sharing'].outcomes
        && chained[data.basket.requestObject.tabId + 'credential-sharing'].outcomes['join_end']

        && chained[data.basket.requestObject.tabId + 'credential-sharing'].outcomes['join_end'].response.data
        && chained[data.basket.requestObject.tabId + 'credential-sharing'].outcomes['join_end'].response.data.isAdminCreds
        ? { checkId: 'CH-FORM-ADMIN-CREDENTIALS' } : {},
        is_idp: chained && chained[data.basket.requestObject.tabId+'app-criticality-checker']
        && chained[data.basket.requestObject.tabId+'app-criticality-checker'].outcomes
        && chained[data.basket.requestObject.tabId+'app-criticality-checker'].outcomes['is-idp-sso']

        && chained[data.basket.requestObject.tabId+'app-criticality-checker'].outcomes['is-idp-sso'].response.data
        ? { checkId: 'CH-APP-IDP' } : {},
        context_id: chained && chained[data.basket.requestObject.tabId+'password-checker-form']
        && chained[data.basket.requestObject.tabId+'password-checker-form'].outcomes
        && chained[data.basket.requestObject.tabId+'password-checker-form'].outcomes['join_end']

        && chained[data.basket.requestObject.tabId+'password-checker-form'].outcomes['join_end'].response.data
        && chained[data.basket.requestObject.tabId+'password-checker-form'].outcomes['join_end'].response.data.context_id
        ? chained[data.basket.requestObject.tabId+'password-checker-form'].outcomes['join_end'].response.data.context_id
        : crypto.randomUUID(),
        app_critical: chained && chained[data.basket.requestObject.tabId+'app-criticality-checker']
        && chained[data.basket.requestObject.tabId+'app-criticality-checker'].outcomes
        && chained[data.basket.requestObject.tabId+'app-criticality-checker'].outcomes['is-app-critical']

        && chained[data.basket.requestObject.tabId+'app-criticality-checker'].outcomes['is-app-critical'].response.data
        ? { checkId: 'CH-APP-CRITICAL' } : { },
        password_weak: data && data.outcome && data.outcome.outcomes
        && data.outcome.outcomes['get-password-strength']

        && data.outcome.outcomes['get-password-strength'].response.data < 3
        ? { checkId: 'CH-FORM-WEAK-PASSWORD' } : {},
        password_compromised: chained && chained[data.basket.requestObject.tabId + 'password-checker-form']
        && chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes
        && chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['is_password_compromised']

        && chained[data.basket.requestObject.tabId + 'password-checker-form'].outcomes['is_password_compromised'].response.data
        ? { checkId: 'CH-FORM-COMPROMISED-PASSWORD', source: 'hibp' } : {},

        admin_password_reused: data && data.outcome && data.outcome.outcomes
        && data.outcome.outcomes['get-credential-reused']
        && Array.isArray(data.outcome.outcomes['get-credential-reused'].response.data)
        && data.outcome.outcomes['get-credential-reused'].response.data.length > 0 && data.outcome.outcomes['get-credential-reused'].response.data.some(e => e.isIdp)
        ? { checkId: 'CH-ADMIN-REUSED-PASSWORD' } : {},

        password_reused: data && data.outcome && data.outcome.outcomes
        && data.outcome.outcomes['get-credential-reused']
        && Array.isArray(data.outcome.outcomes['get-credential-reused'].response.data)
        && data.outcome.outcomes['get-credential-reused'].response.data.length > 0
        ? { checkId: 'CH-FORM-REUSED-PASSWORD', data: data.outcome.outcomes['get-credential-reused'].response.data } : {},

        isLogin: data && data.outcome && data.outcome.outcomes
        && data.outcome.outcomes['is-login']

        && data.outcome.outcomes['is-login'].response.data
        ? { checkId: 'CH-FORM-LOGIN' } : { checkId: 'CH-FORM-SIGNUP' },
        credential_shared: chained && chained[data.basket.requestObject.tabId+'credential-sharing']
        && chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes
        && chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes['join_end']
        && chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes['join_end'].response.data
        && chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes['join_end'].response.data.credential_shared
        && chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes['join_end'].response.data.credential_shared.data
        ? { checkId: 'CH-FORM-SHARED-CREDENTIAL', data: chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes['join_end'].response.data.credential_shared.data } : {},
        }))"
  - name: get-check-ids
    type: effect
    config:
      command: "checkIds(data.outcome.outcomes)"
  - name: check-findings
    type: effect
    config:
      command: getFindings(data.outcome.outcomes["get-check-ids"].response.data)
  - name: process-notifications
    type: effect
    config:
      command: "showNotification(data, data.outcome.outcomes['join_end'].response.data.context_id, 'headers', data.outcome.outcomes['is-login'].response.data,  chained[data.basket.requestObject.tabId+'credential-sharing'].outcomes['join_end'].response.data.credential_shared.data ? true: false)"
  - name: should_send_notification
    type: condition_eval
    config:
      condition: "Array.isArray(data.outcome.outcomes['process-notifications'].response.data) && data.outcome.outcomes['process-notifications'].response.data.length > 0 ? true : false"
  - name: show-notification
    type: send_notification
    config:
      command: data.outcome.outcomes['process-notifications'].response.data
      delayed: true

persona:
  roles:
    - PRIVILEGED_ACCESS
application:
  urlpattern: "https://login.microsoftonline.com/common/login"
  analysismethod: "includes"
browser: true
args:
  requesttype: POST
  urls: ["<all_urls>"]
  opt_extraInfoSpec: ["responseHeaders", "extraHeaders"]
event: onHeadersReceived
active: true
element: request
chain: true
configurable: false
