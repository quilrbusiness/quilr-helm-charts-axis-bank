name: password-checker-before
version: 1.0.0
sequences:
  - name: check-chain
    waiton: []
    next:
      - name: get-event-type
        waiton: [check-chain]
        next: []
      - name: get-event-body
        waiton: [check-chain]
        next: []
  - name: get-email
    waiton: []
    next: []
  - name: get-password
    waiton: []
    next:
      - name: hash-password
        waiton: [get-password]
        next:
          - name: get-saved-credentials
            waiton: [hash-password]
            next: []
  - name: analyze-password
    waiton: [get-password]
    next:
      - name: is_password_weak
        waiton: [analyze-password]
        ifnext:
          name: password_is_weak
          waiton: [is_password_weak]
          next: []
        elsenext: {}
      - name: is_password_compromised
        waiton: [analyze-password]
        ifnext:
          name: password_compromised
          waiton: [is_password_compromised]
          next: []
        elsenext: {}
  - name: get-request-url
    waiton: []
    next: []

actions:
  - name: hash-password
    type: hash
    config:
      params: data.outcome.outcomes['get-password'].response.data.password
  - name: get-request-url
    type: effect
    config:
      command: data.basket.requestObject.url
  - name: check-chain
    type: effect
    config:
      command: chained && Object.entries(chained).filter(([key, val]) => key.startsWith(data.basket.requestObject.tabId + 'password-checker-form'))
  - name: get-event-type
    type: effect
    config:
      command: data.outcome.outcomes['check-chain'].response.data.length > 0 && data.outcome.outcomes['check-chain'].response.data[0][1].outcomes['check_login_signup'].response.data
  - name: get-event-body
    type: effect
    config:
      command: data.outcome.outcomes['check-chain'].response.data.length > 0 && data.outcome.outcomes['check-chain'].response.data[0][1]
  - name: get-email
    type: effect
    config:
      command: checkBody(data.basket.requestObject, [['email', 'mail', 'login_email' ]])
  - name: get-password
    type: effect
    config:
      command: checkBody(data.basket.requestObject, [['password', 'encrypted_password']])
  - name: analyze-password
    type: check_password
    config:
      password: data.outcome.outcomes['get-password'].response.data.password
  - name: is_password_weak
    type: condition_eval
    config:
      condition: "data.outcome.outcomes['analyze-password'].response.data.score < 3"
  - name: password_is_weak
    type: effect
    config:
      checkId: CH-BEFORE-REQUEST-WEAK-PASSWORD
      command: "true"

  - name: is_password_compromised
    type: condition_eval
    config:
      condition: "data.outcome.outcomes['analyze-password'].response.data.feedback.warning.indexOf('breach') > 1 "
  - name: password_compromised
    type: effect
    config:
      checkId: CH-BEFORE-REQUEST-COMPROMISED-PASSWORD
      command: "true"
  - name: get-saved-credentials
    type: lookup
    config:
      lookup_name: login_details
      lookup_condition: "data.outcome.outcomes['hash-password'].response.data ? allLookups['login_details'].filter(e => !data.basket.requestObject.initiator.includes(e.domain) && data.outcome.outcomes['hash-password'].response.data && e.hash === data.outcome.outcomes['hash-password'].response.data): []"
  - name: check-password-strength
    type: check_password
    config:
      password: data.basket.ev.target.value

persona:
  roles:
    - PRIVILEGED_ACCESS
application:
  urlpattern: "<all_urls>"
  analysismethod: ""
browser: true
args:
  requesttype: POST
  requestbodytype: object
  containskeys: [[email, mail, login_email], [password, encrypted_password]]
  opt_extraInfoSpec: ["requestBody"]
event: onBeforeRequest
active: true
element: request
chain: true
configurable: false
