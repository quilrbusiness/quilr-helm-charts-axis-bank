name: credential-sharing
version: 1.0.0
sequences:
  - name: check_login_signup
    waiton: []
    next: []
  - name: get-email
    waiton: []
    next: []
  - name: get_employee_details
    waiton: [get-email]
    next:
      - name: is-credential-shared
        waiton: [get_employee_details]
        next:
          - name: join_end
            waiton: [is-credential-shared, check_login_signup]
            next:
              - name: get-check-ids
                waiton: [join_end]
                next:
                  - name: check-findings
                    waiton: [get-check-ids]
                    next:
                      - name: process-notifications
                        waiton: [check-findings]
                        next:
                          - name: should-show-notification
                            waiton: [process-notifications]
                            ifnext:
                              name: show-notification
                              waiton: [should-show-notification]
                              next:
                                - name: END
                            elsenext:
                              name: END

actions:
  - name: get-email
    type: effect
    config:
      command: data.basket.ev.target.value
  - name: check_login_signup
    type: login-signup-check
    config:
      params: true
  - name: get_employee_details
    type: fetch_data
    config:
      body: "JSON.parse(JSON.stringify({mail: data.outcome.outcomes['get-email'].response.data}))"
      method: POST
      url: /browser-extension/browser/extension/fetch-user-details
      headers: {}
  - name: is-credential-shared
    type: effect
    config:
      command: "data.outcome.outcomes['get_employee_details'].response.data && data.outcome.outcomes['get_employee_details'].response.data.userMail && data.outcome.outcomes['get_employee_details'].response.data.userMail !== persona.emailaddress ? true : false"
  - name: join_end
    type: effect
    config:
      command: "JSON.parse(JSON.stringify({
        isAdminCreds: data.outcome.outcomes['get_employee_details'].response.data && data.outcome.outcomes['get_employee_details'].response.data.isAdmin ? { checkId: 'CH-FORM-ADMIN-CREDENTIALS' } : false,
        context_id: chained && chained[data.basket.tabId+'app-criticality-checker'].outcomes['generate-context-id'].response.data ? chained[data.basket.tabId+'app-criticality-checker'].outcomes['generate-context-id'].response.data: '',
        app_critical: chained && chained[data.basket.tabId+'app-criticality-checker'].outcomes['is-app-critical'].response.data ? { checkId: 'CH-APP-CRITICAL', data: chained[data.basket.tabId+'app-criticality-checker'].outcomes['is-app-critical'].response.data } : { },
        credential_shared: data.outcome.outcomes['is-credential-shared'].response.data ? { checkId: 'CH-FORM-SHARED-CREDENTIAL', data: data.outcome.outcomes['get_employee_details'].response.data } : {},
        isLogin: data.outcome.outcomes['check_login_signup'].response.data === 'Login' ? { checkId: 'CH-FORM-LOGIN' } : data.outcome.outcomes['check_login_signup'].response.data === 'Signup' ? { checkId: 'CH-FORM-SIGNUP' }: {}
        }))"
  - name: get-check-ids
    type: effect
    config:
      command: "checkIds(data.outcome.outcomes)"
  - name: check-findings
    type: effect
    config:
      command: getFindings(data.outcome.outcomes["get-check-ids"].response.data)
  - name: process-notifications
    type: effect
    config:
      command: showNotification(data, data.outcome.outcomes['join_end'].response.data.context_id ,'form', data.outcome.outcomes['check_login_signup'].response.data === 'Login',  data.outcome.outcomes['is-credential-shared'].response.data)
  - name: should-show-notification
    type: condition_eval
    config:
      condition: "data.outcome.outcomes['process-notifications'].response.data && Array.isArray(data.outcome.outcomes['process-notifications'].response.data) && data.outcome.outcomes['process-notifications'].response.data.length > 0 ? true : false"
  - name: show-notification
    type: send_notification
    config:
      command: data.outcome.outcomes['process-notifications'].response.data
persona:
  roles:
    - PRIVILEGED_ACCESS
application:
  urlpattern: "<all_urls>"
  analysismethod: ""
browser: true
args:
  target: input[type*='email'], input[name*='email'], input[id*='email'], input[name*='username'], input[id*='username'], input[placeholder*='email'], input[id*='username'], div[id*='displayName']
event: input
active: true
element: window
chain: true
configurable: false
