name: password-checker-form
version: 1.0.0
sequences:
  - name: get-password
    waiton: []
    next: []
  - name: check_login_signup
    waiton: []
    next: []
  - name: password-manager-used
    waiton: []
    next: []
  - name: get-email
    waiton: []
    next:
      - name: get-email-value
        waiton: [get-email]
        next:
          - name: get-credentials-details
            waiton: [get-email-value]
            next:
              - name: is-credential-shared-ch
                waiton: [get-credentials-details]
                next: []

  - name: hash_password
    waiton: []
    next:
      - name: get-saved-credentials
        waiton: [hash_password]
        next:
          - name: get-creds-fingerprint
            waiton: [get-saved-credentials]
            next: []
  - name: check-password-strength
    waiton: []
    next:
      - name: is_password_weak
        waiton: [check-password-strength]
        next: []
      - name: is_password_compromised
        waiton: [check-password-strength]
        next: []
      - name: join_end
        waiton:
          [
            is_password_compromised,
            is_password_weak,
            get-saved-credentials,
            get-email,
            password-manager-used,
            check_login_signup,
          ]
        next:
          - name: make-check-ob
            waiton: [join_end]
            next:
              - name: save-check-ob
                waiton: [make-check-ob]
                next: []
          - name: get-check-ids
            waiton: [join_end]
            next:
              - name: check-findings
                waiton: [get-check-ids]
                next:
                  - name: process-notifications
                    waiton: [check-findings]
                    next:
                      - name: process-notifications-block
                        waiton: [check-findings]
                        next:
                          - name: is-blocked
                            waiton: [process-notifications-block]
                            ifnext:
                              name: send-blocked
                              waiton: [is-blocked]
                              next: []
                            elsenext: {}
                      - name: should-show-notification
                        waiton: [process-notifications]
                        ifnext:
                          name: show-notification
                          waiton:
                            [
                              should-show-notification,
                              process-notifications-block,
                              is-blocked,
                            ]
                          next:
                            - name: END
                        elsenext:
                          name: END

actions:
  - name: get-credentials-details
    type: execute-process
    config:
      chained: data.basket.tabId + "credential-sharing"
      fallback:
        api:
          body: "JSON.parse(JSON.stringify({mail: data.outcome.outcomes['get-email-value'].response.data.email}))"
          method: POST
          url: /browser-extension/browser/extension/fetch-user-details
          headers: {}
          cache: true
  - name: get_employee_details
    type: fetch_data
    config:
      body: "JSON.parse(JSON.stringify({mail: data.outcome.outcomes['get-email-value'].response.data.email}))"
      method: POST
      url: /browser-extension/browser/extension/fetch-user-details
      headers: {}
      cache: true
  - name: is-credentials-sharing-complete
    type: condition_eval
    config:
      condition: "chained && chained[data.basket.tabId + 'credential-sharing'] && chained[data.basket.tabId + 'credential-sharing'].outcomes['get_employee_details'].response.data && chained[data.basket.tabId + 'credential-sharing'].outcomes['get_employee_details'].response.data.userMail ? chained[data.basket.tabId + 'credential-sharing'].outcomes['get_employee_details'].response.data.userMail.toLowerCase() === data.outcome.outcomes['get-email-value'].response.data.email.toLowerCase(): false"
  - name: get-password
    type: effect
    config:
      command: data.basket.ev.target.value
  - name: check_login_signup
    type: login-signup-check
    config:
      params: true
  - name: is-credential-shared-ch
    type: effect
    config:
      command: "data.outcome.outcomes['get-credentials-details'].response.data && data.outcome.outcomes['get-credentials-details'].response.data.userMail && data.outcome.outcomes['get-credentials-details'].response.data.userMail === persona.emailaddress ? true : false"
  - name: is-credential-shared
    type: effect
    config:
      command: "chained && chained[data.basket.tabId + 'credential-sharing'] && chained[data.basket.tabId + 'credential-sharing'].outcomes['is-credential-shared'].response.data ? { status: true } : { status: false }"
  - name: hash_password
    type: hash
    config:
      params: data.basket.ev.target.value
  - name: is_login
    type: effect
    config:
      command: "true"
  - name: password-manager-used
    type: effect
    config:
      command: "data.basket.ev.target.value !== '' &&
        data.basket.ev.inputType === undefined  &&
        data.basket.ev.data === undefined &&
        data.basket.ev.dataTransfer === undefined &&
        data.basket.ev.isComposing === undefined"
  - name: get-email
    type: get_dom_element
    config:
      matcher: "input[type*='email'], input[name*='email'], input[id*='email'], input[name*='username'], input[id*='username'], input[placeholder*='email'], input[id*='username'], div[id='displayName'], form[name='activateNewUser'] > div > p > strong"
  - name: get-email-value
    type: effect
    config:
      command: "JSON.parse(JSON.stringify({ email: chained && chained[data.basket.tabId + 'credential-sharing'] && chained[data.basket.tabId + 'credential-sharing'].outcomes['get-email'].response.data.length > 0 ? chained[data.basket.tabId + 'credential-sharing'].outcomes['get-email'].response.data : data.outcome.outcomes['get-email'].response.data.element.tagName === 'DIV'? data.outcome.outcomes['get-email'].response.data.element.title : data.outcome.outcomes['get-email'].response.data.element.value }))"
  - name: get-saved-credentials
    type: lookup
    config:
      lookup_name: login_details
      lookup_condition: "data.outcome.outcomes['hash_password'].response.data &&
        data.outcome.outcomes['hash_password'].response.data.length > 0
        ? allLookups['login_details'].filter(e => e.hash === data.outcome.outcomes['hash_password'].response.data)
        : []"
  - name: get-creds-fingerprint
    type: effect
    config:
      command: "data.outcome.outcomes['get-saved-credentials'].response.data && data.outcome.outcomes['get-saved-credentials'].response.data.length > 0 ? data.outcome.outcomes['get-saved-credentials'].response.data[0].passwordId : '' "

  - name: check-password-strength
    type: check_password
    config:
      password: data.basket.ev.target.value

  - name: is_password_weak
    type: effect
    config:
      command: "data.outcome.outcomes['get-password'].response.data ? data.outcome.outcomes['check-password-strength'].response.data.score < 3 : false"
  - name: join_end
    type: effect
    config:
      command: "JSON.parse(JSON.stringify({
        isAppUnapproved: chained && chained[data.basket.tabId+'app-criticality-checker'].outcomes['is-app-unapproved'].response.data ? { checkId: 'CH-APP-UNAPPROVED' } : {},
        isAdmin: persona.details && persona.details.isAdmin ? { checkId: 'CH-FORM-ADMIN' } : {},
        isAdminCredentials: chained && chained[data.basket.tabId + 'credential-sharing'] && chained[data.basket.tabId + 'credential-sharing'].outcomes['join_end'] && chained[data.basket.tabId + 'credential-sharing'].outcomes['join_end'].response.data && chained[data.basket.tabId + 'credential-sharing'].outcomes['join_end'].response.data.isAdminCreds ? { checkId: 'CH-FORM-ADMIN-CREDENTIALS' } : {},
        context_id: chained && chained[data.basket.tabId+'app-criticality-checker'].outcomes['generate-context-id'].response.data ? chained[data.basket.tabId+'app-criticality-checker'].outcomes['generate-context-id'].response.data: '',
        is_idp: chained && chained[data.basket.tabId+'app-criticality-checker'].outcomes['is-idp-sso'].response.data ? { checkId: 'CH-APP-IDP' } : {  },
        app_critical: chained && chained[data.basket.tabId+'app-criticality-checker'].outcomes['is-app-critical'].response.data ? { checkId: 'CH-APP-CRITICAL' } : { },
        password_weak: data.outcome.outcomes['is_password_weak'].response.data ? { checkId: 'CH-FORM-WEAK-PASSWORD' } : {},
        password_compromised: data.outcome.outcomes['is_password_compromised'].response.data ? { checkId: 'CH-FORM-COMPROMISED-PASSWORD', source: 'hibp' }: {},
        password_reused: data.outcome.outcomes['get-saved-credentials'].response.data && data.outcome.outcomes['get-saved-credentials'].response.data.filter(e => e.domain !== stripUrl(data.basket.appUrl)).length > 0 ? { checkId: 'CH-FORM-REUSED-PASSWORD', data: data.outcome.outcomes['get-saved-credentials'].response.data.filter(e => e.domain !== stripUrl(data.basket.appUrl))  }: {},
        critcal_password_reused: data.outcome.outcomes['get-saved-credentials'].response.data && data.outcome.outcomes['get-saved-credentials'].response.data.filter(e => e.domain !== stripUrl(data.basket.appUrl) && e.isCritical).length > 0  ? { checkId: 'CH-CRITICAL-REUSED-PASSWORD' }: {},
        admin_password_reused: data.outcome.outcomes['get-saved-credentials'].response.data && data.outcome.outcomes['get-saved-credentials'].response.data.filter(e => e.domain !== stripUrl(data.basket.appUrl) && e.isIdp).length > 0  ? { checkId: 'CH-ADMIN-REUSED-PASSWORD' }: {},
        isLogin: data.outcome.outcomes['check_login_signup'].response.data === 'Login' ? { checkId: 'CH-FORM-LOGIN' } : data.outcome.outcomes['check_login_signup'].response.data === 'Signup' ? { checkId: 'CH-FORM-SIGNUP' }: {}
        }))"
  - name: is_password_compromised
    type: effect
    config:
      command:
        "data.outcome.outcomes['get-password'].response.data &&
        data.outcome.outcomes['check-password-strength'].response.data &&
        data.outcome.outcomes['check-password-strength'].response.data.feedback &&
        data.outcome.outcomes['check-password-strength'].response.data.feedback.warning
        ? data.outcome.outcomes['check-password-strength'].response.data.feedback.warning.indexOf('breach') > -1
        : false"
  - name: send-blocked
    type: send_logs
    config:
      args: data.outcome.outcomes['make-check-ob'].response.data
      check_mfa: true
  - name: save-check-ob
    type: save-event
    config:
      check: data.outcome.outcomes['make-check-ob'].response.data
      once: true
  - name: make-check-ob
    type: effect
    config:
      command: "JSON.parse(JSON.stringify({
        check: {
        id: 'CID_16',
        name: 'login',
        properties: {
        cred_fingerprint_id: data.outcome.outcomes['get-creds-fingerprint'].response.data ? data.outcome.outcomes['get-creds-fingerprint'].response.data : crypto.randomUUID(),
        context_id: data.outcome.outcomes['join_end'].response.data.context_id ? data.outcome.outcomes['join_end'].response.data.context_id : crypto.randomUUID(),
        signup:  data.outcome.outcomes['check_login_signup'].response.data === 'Signup' ? true: false,
        credentials: { email: chained && chained[data.basket.tabId + 'credential-sharing'] ? chained[data.basket.tabId + 'credential-sharing'].outcomes['get-email'].response.data : data.outcome.outcomes['get-email'].response.data.element.value ? data.outcome.outcomes['get-email'].response.data.element.value : data.outcome.outcomes['get-email'].response.data.element.title },
        credential_shared: chained && chained[data.basket.tabId+'credential-sharing'] && chained[data.basket.tabId+'credential-sharing'].outcomes['join_end'].response.data && chained[data.basket.tabId+'credential-sharing'].outcomes['join_end'].response.data.credential_shared.data ? { status: true } : { status: false },
        password_strength: data.outcome.outcomes['check-password-strength'].response.data.score,
        compromised_password: data.outcome.outcomes['is_password_compromised'].response.data ? { status: true, source: 'hibp' }: { status: false },
        credential_reused: data.outcome.outcomes['get-saved-credentials'].response.data && data.outcome.outcomes['get-saved-credentials'].response.data.filter(e => e.domain !== stripUrl(data.basket.appUrl)).length > 0 ? { status: true, details: data.outcome.outcomes['get-saved-credentials'].response.data.filter(e => e.domain !== stripUrl(data.basket.appUrl)).map(e => ({ domain: e.domain, email: e.id }))  }: { status: false },
        using_password_manager: data.outcome.outcomes['password-manager-used'].response.data,
        mfatype: '',
        mfastrength: '',
        be_mfa_enabled: false,
        },
        },
        url: data.basket.appUrl,
        title: stripUrl(data.basket.appUrl)
        }))"

  - name: get-check-ids
    type: effect
    config:
      command: "checkIds(data.outcome.outcomes)"
  - name: check-findings
    type: effect
    config:
      command: getFindings(data.outcome.outcomes["get-check-ids"].response.data)
  - name: process-notifications
    type: effect
    config:
      command: showNotification(data, data.outcome.outcomes['join_end'].response.data.context_id, 'form', data.outcome.outcomes['check_login_signup'].response.data === 'Login',  data.outcome.outcomes['is-credential-shared-ch'].response.data.status)
  - name: process-notifications-block
    type: save-block-state
    config:
      command: showNotification(data, data.outcome.outcomes['join_end'].response.data.context_id, 'block', data.outcome.outcomes['check_login_signup'].response.data === 'Login',  data.outcome.outcomes['is-credential-shared-ch'].response.data.status)
  - name: is-blocked
    type: condition_eval
    config:
      condition: "Array.isArray(data.outcome.outcomes['process-notifications-block'].response.data) && data.outcome.outcomes['process-notifications-block'].response.data.length > 0 && data.outcome.outcomes['process-notifications-block'].response.data[0].typpe === 'block'  ? true : false"
  - name: should-show-notification
    type: condition_eval
    config:
      condition: "Array.isArray(data.outcome.outcomes['process-notifications'].response.data) && data.outcome.outcomes['process-notifications'].response.data.length > 0 ? true : false"
  - name: show-notification
    type: send_notification
    config:
      command: data.outcome.outcomes['process-notifications'].response.data

persona:
  roles:
    - PRIVILEGED_ACCESS
application:
  urlpattern: "<all_urls>"
  analysismethod: ""
browser: true
args:
  target: "input[type='password'], input[name*='password'], input[id*='password'], input[placeholder*='password']"
event: input
active: true
element: window
chain: true
configurable: false
