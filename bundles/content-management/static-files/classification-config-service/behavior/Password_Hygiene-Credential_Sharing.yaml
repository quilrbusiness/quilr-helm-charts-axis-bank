id: 9a570cfc-c43f-43ef-94dd-b498aef4174e
version: 4.8
code: BID_09
name: Credential Sharing
type: behavior
createdon: 1710504494000
updatedon: 1710504494000
posture:
  - PID_03
browser_enabled: true
description: Users sharing credential with another user.
query: "MATCH (source_user_email:EMAIL {subscriber: $subscriber, tenant: $tenant})-[source_credsbased_account:CREDSBASED_ACCOUNT]->(source_account:ACCOUNT)<-[credential_shared:CREDENTIAL_SHARED]-(account:ACCOUNT)
          WHERE account <> source_account AND toLower(account.email) <> toLower(source_account.email)
          OPTIONAL MATCH (source_user:USER)-[has_email1:HAS_EMAIL]->(source_user_email)
          MATCH (source_account)-[using_app:USING_APP]->(app:APPLICATION),
                (account)<-[credsbased_account:CREDSBASED_ACCOUNT]-(email:EMAIL)<-[has_email:HAS_EMAIL]-(user:USER)
          OPTIONAL MATCH (app)-[has_app_category:HAS_APP_CATEGORY]->(app_category:APP_CATEGORY)
          OPTIONAL MATCH (tenant:TENANT {id: $tenant})-[app_settings:HAS_APP_SETTINGS]-(app) 
          OPTIONAL MATCH (source_account:ACCOUNT)-[using_browser:HAS_BROWSER]-(browser:BROWSER)
          OPTIONAL MATCH (user)-[:BELONGS_TO]->(group:GROUP {userDefined: true})
          OPTIONAL MATCH (source_user)-[:BELONGS_TO]->(source_group:GROUP {userDefined: true})
          OPTIONAL MATCH (user)-[:HAS_DEPARTMENT]->(department:DEPARTMENT)
          OPTIONAL MATCH (source_user)-[:HAS_DEPARTMENT]->(source_department:DEPARTMENT)
          OPTIONAL MATCH (tenant:TENANT {id: $tenant})-[:HAS_INSTANCE]-(instance:INSTANCE)-[has_idp:HAS_IDP]-(:APPLICATION)
          WITH source_user,has_email1,source_user_email,credsbased_account,source_account,using_app,app,credential_shared,group,source_group,email,has_email,user,
            account,app_category,app_settings,instance,has_idp,source_credsbased_account
          WHERE credsbased_account.timestamp >= $starttime AND credsbased_account.timestamp <= $endtime
          WITH source_user,has_email1,source_user_email,credsbased_account,source_account,using_app,app,credential_shared,group,source_group,email,has_email,user,
            account,app_category,app_settings,instance,has_idp,source_credsbased_account
          RETURN DISTINCT
              user.displayName AS userName,
              COALESCE(source_user.displayName, source_user_email.id) AS userNameSource,
              COALESCE(user.mail, email.id) AS userMail,
              COALESCE(source_user.mail, source_user_email.id) AS userMailSource,
              account.email AS email,
              source_account.email AS emailSource,
              account.id AS userAppAccount,
              source_account.id AS userAppAccountSource,
              COALESCE(user.accountEnabled, 'ACTIVE') as userAccountEnabled,
              source_user_email.tenant as TENANT,
              source_user_email.subscriber AS SUBSCRIBER,
              app.id_ as appId,
              COALESCE(CASE WHEN NOT app.name IN ['', '-'] THEN app.name ELSE NULL END, app.domain) AS appName,
              app.Url AS appUrl,
              app.domain AS appDomain,
              COLLECT(app_category.name) AS appCategory,
              COALESCE(app_settings.criticality, app.criticality, 'NOT SET') AS appCriticality, 
              source_credsbased_account.context_id as CONTEXTID,
              credsbased_account.last_access_time as EVENTTIME"
config:
  expression: "def fn(message): return True if message.get('userName') else False "
  type: finding
  subtype: status
  status: open
  sla: 1W
  entity: userName
  entitytype: user
  tags:
    - insecure_behavior
  sourceofalert: Quilr
  template: "Received an alert for the User: ${userName} on Application: ${appName}"
  artifacts:
    - type: "ACCOUNT"
      property: "id"
      value: "$userAppAccountSource"
      artifactproperties:
        artifactValue: $userNameSource
        displayInUI: enabled
        artifactKey: "Credential Shared By"
    - type: "ACCOUNT"
      property: "id"
      value: "$userAppAccount"
      artifactproperties: 
        artifactValue: $userName
        displayInUI: enabled
        artifactKey: "Credential Used By"
    - type: "APPLICATION" 
      context: "global" 
      property: id_
      value: $appId
      artifactproperties: 
        artifactValue: $appName
        displayInUI: enabled
        artifactKey: "Application"
    - type: "IPADDRESS"
      property: "id"
      value: "$ipaddress"
      artifactproperties: 
        artifactValue: $ipaddress
        displayInUI: enabled
        artifactKey: "IP Address"
  properties:
    userName: $userName
    userMail: $userMail
    userAccountEnabled: $userAccountEnabled
    TENANT: $TENANT
    SUBSCRIBER: $SUBSCRIBER
    appName: $appName
    appUrl: $appUrl
    appId: $appId
    accountId: $userAppAccount
    sharedAccountId: $userAppAccountSource
    appCategory: $appCategory 
    appDomain: $appDomain
    context_id: $CONTEXTID
    eventtime: $EVENTTIME
lambda: ""