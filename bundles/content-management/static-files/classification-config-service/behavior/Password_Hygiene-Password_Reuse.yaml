id: 8b93f38f-f9de-4f01-9cb6-36ef9749a641
version: 4.13
code: BID_10
name: Password Reuse
type: behavior
createdon: 1710504494000
updatedon: 1710504494000
posture:
  - PID_03
browser_enabled: true
description: Users reusing same password on other applications.
query: "MATCH (user:USER {subscriber: $subscriber, tenant: $tenant})-[has_email:HAS_EMAIL]-(email:EMAIL)-[credsbased_account:CREDSBASED_ACCOUNT]-(account:ACCOUNT)
          -[has_cred_fingerprint:HAS_CRED_FINGERPRINT]->(cred_fingerprint:CRED_FINGERPRINT)<-[:HAS_CRED_FINGERPRINT]-(source_account:ACCOUNT)
        WHERE account.tenant = source_account.tenant AND account <> source_account
        MATCH (account)-[using_app:USING_APP]->(app:APPLICATION)
        MATCH (source_account)-[:USING_APP]->(source_app:APPLICATION)
        OPTIONAL MATCH (app) - [has_app_category:HAS_APP_CATEGORY] - (app_category:APP_CATEGORY) 
        OPTIONAL MATCH (account)-[using_browser:HAS_BROWSER] - (browser:BROWSER) 
        OPTIONAL MATCH (:TENANT {id: $tenant})-[app_settings:HAS_APP_SETTINGS]-(app) 
        OPTIONAL MATCH (user)-[:BELONGS_TO]->(group:GROUP {userDefined: true}) 
        OPTIONAL MATCH (user)-[:HAS_DEPARTMENT]->(department:DEPARTMENT) 
        OPTIONAL MATCH (:TENANT {id: $tenant})-[:HAS_INSTANCE]-(instance:INSTANCE)-[has_idp:HAS_IDP]-(idp_app:APPLICATION) 
        OPTIONAL MATCH (source_app)<-[source_has_idp:HAS_IDP]-(:INSTANCE) 
        OPTIONAL MATCH (:TENANT {id: $tenant})-[source_app_settings:HAS_APP_SETTINGS]-(source_app) 
        
        WITH user,has_email,email,credsbased_account,account,cred_fingerprint,has_cred_fingerprint,using_app,app,
          group, department,app_category,browser,using_browser,instance,has_idp,
          source_has_idp is not null as isSourceAppIdp, source_app_settings, source_app
        
        WHERE credsbased_account.timestamp >= $starttime AND credsbased_account.timestamp <= $endtime 
        
        WITH user,has_email,email,credsbased_account,account,cred_fingerprint,has_cred_fingerprint,using_app,app,
          group,department,app_category,browser,using_browser,instance,has_idp,isSourceAppIdp, source_app_settings, source_app
        
        RETURN DISTINCT 
          user.id AS userId, 
          user.displayName AS userName, 
          user.mail AS userMail, 
          user.accountEnabled as userAccountEnabled, 
          department.name as userDepartment, 
          user.tenant as TENANT, 
          user.subscriber AS SUBSCRIBER, 
          app.id_ as appId, 
          COALESCE(CASE WHEN NOT app.name IN ['', '-'] THEN app.name ELSE NULL END, app.domain) AS appName, 
          app.Url AS appUrl, 
          COLLECT(distinct app_category.name) AS appCategory, 
          app.domain AS appDomain, 
          account.id AS userAppAccount,
          browser.id as browserUsed, 
          MIN(cred_fingerprint.password_strength) as passwordStrength, 
          using_browser.client_ip as ipaddress, 
          credsbased_account.context_id as CONTEXTID"
config:
  expression: "def fn(message): return True if message.get('userName') else False "
  type: finding
  subtype: status
  status: open
  sla: 1W
  entity: userName
  entitytype: user
  tags:
    - insecure_behavior
  sourceofalert: Quilr
  template: "Received an alert for the User: ${userName} on Application: ${appName}"
  artifacts: 
    - type: "ACCOUNT"
      property: "id"
      value: "$userAppAccount"
      artifactproperties: 
        artifactValue: $userName
        displayInUI: enabled
    - type: "APPLICATION" 
      context: "global" 
      property: id_
      value: $appId
      artifactproperties: 
        artifactValue: $appName
        displayInUI: enabled
    - type: "IPADDRESS"
      property: "id"
      value: "$ipaddress"
      artifactproperties: 
        artifactValue: $ipaddress
        displayInUI: enabled
  properties:
    userId: $userId  #FORMAT - findingattribute: variable from the top of this YAML
    userName: $userName
    userMail: $userMail
    userAccountEnabled: $userAccountEnabled
    userDepartment: $userDepartment
    TENANT: $TENANT
    SUBSCRIBER: $SUBSCRIBER
    appName: $appName
    appUrl: $appUrl
    appId: $appId
    accountId: $userAppAccount
    appCategory: $appCategory  
    credsbased_accountReusedApps: $credsbased_accountReusedApps
    credsbased_accountReusedEmail: $credsbased_accountReusedEmail
    appDomain: $appDomain
    passwordStrength: $passwordStrength
    browser: $browserUsed
    context_id: $CONTEXTID
lambda: ""