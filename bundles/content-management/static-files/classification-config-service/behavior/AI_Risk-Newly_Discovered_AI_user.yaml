id: 15493083-1c21-4b44-9ff9-29a7c2575e75
version: 3.3
code: BID_02
name: Newly Introduced AI Users
type: behavior
createdon: 1710504494000
updatedon: 1710504494000
posture:
  - PID_01
browser_enabled: true
description: These are users who have recently started using AI application in your environment.
query: "MATCH (user:USER {subscriber: $subscriber, tenant: $tenant})-[has_email:HAS_EMAIL]-(email:EMAIL),
              (email)-[credsbased_account]-(account:ACCOUNT)-[using_app:USING_APP]-(app:APPLICATION)
        OPTIONAL MATCH (account)-[:INITIATED]->(browser_event:BROWSER_EVENT)
        OPTIONAL MATCH (app) - [has_app_category:HAS_APP_CATEGORY] - (app_category:APP_CATEGORY)
        OPTIONAL MATCH (tenant:TENANT {id: $tenant})-[app_settings:HAS_APP_SETTINGS]-(app)
        OPTIONAL MATCH (tenant:TENANT {id: $tenant})-[:HAS_INSTANCE]-(instance:INSTANCE)-[has_idp:HAS_IDP]-(app:APPLICATION)
        WITH user, email, credsbased_account, account, browser_event, using_app, app, app_category, tenant, app_settings,instance,has_idp
        WHERE toLower(app_category.name) = 'generative ai'
              AND type(credsbased_account) IN ['GUEST_ACCOUNT', 'CREDSBASED_ACCOUNT', 'OAUTH_ACCOUNT']
              AND account.creationTime >= $starttime
              AND account.creationTime <= $endtime
        WITH user, email, credsbased_account, account, browser_event, using_app, app, app_category, tenant, app_settings,instance,has_idp
        RETURN DISTINCT
              user.id AS userId,
              user.displayName AS userName,
              user.mail AS userMail,
              user.accountEnabled AS userAccountEnabled,
              user.tenant AS TENANT,
              user.subscriber AS SUBSCRIBER,
              app.id_ AS appId,
              COALESCE(CASE WHEN NOT app.name IN ['', '-'] THEN app.name ELSE NULL END, app.domain) AS appName,
              app.Url AS appUrl,
              app.domain AS appDomain,
              COLLECT(app_category.name) AS appCategory,
              account.id AS userAppAccount,
              COALESCE(app_settings.criticality, app.criticality, 'NOT SET') AS appCriticality,
              credsbased_account.context_id as CONTEXTID,
              credsbased_account.last_access_time as EVENTTIME"
config:
  expression: "def fn(message): return True if message.get('userName') else False "
  type: finding
  subtype: status
  status: open
  sla: 1W
  entity: userName
  entitytype: user
  tags:
    - insecure_behavior
  sourceofalert: Quilr
  template: "Received an alert for the User: ${userName} on Application: ${appName}"
  artifacts: 
    - type: "ACCOUNT"
      property: "id"
      value: "$userAppAccount"
      artifactproperties: 
        artifactValue: $userName
        displayInUI: enabled
        artifactKey: "User"
    - type: "APPLICATION" 
      context: "global" 
      property: id_
      value: "$appId"
      artifactproperties: 
        artifactValue: $appName
        displayInUI: enabled
        artifactKey: "Application"
    - type: "APP_CRITICALITYy"
      property: "criticality"                                 
      value: "$appCriticality"                                
      artifactproperties: 
        artifactValue: $appCriticality
        displayInUI: enabled
        artifactKey: "Critical"
  properties:
    userId: $userId
    userName: $userName
    userMail: $userMail
    userAccountEnabled: $userAccountEnabled
    TENANT: $TENANT
    SUBSCRIBER: $SUBSCRIBER
    appName: $appName
    appUrl: $appUrl
    appId: $appId
    accountId: $userAppAccount
    appCategory: $appCategory 
    appDomain: $appDomain
    context_id: $CONTEXTID
    time: $EVENTTIME
lambda: ""