id: 576359c1-5cd2-4915-93e0-066963be23e2
version: 3.6
code: BID_12
name: High Risk Oauth Scope
type: behavior
createdon: 1710504494000
updatedon: 1710504494000
posture:
  - PID_04
browser_enabled: false
description: User with high risk oauth scope given to SaaS app.
query: "MATCH (user:USER {subscriber: $subscriber, tenant: $tenant}) - [has_email:HAS_EMAIL] - (email:EMAIL) - [credsbased_account:OAUTH_ACCOUNT] - (account:ACCOUNT),
              (account) - [using_app:USING_APP] - (app:APPLICATION) - [has_grant:HAS_GRANT] - (grant:GRANT) - [has_scope:HAS_SCOPE] - (scope:SCOPE)
        WHERE credsbased_account.timestamp >= $starttime
              AND credsbased_account.timestamp <= $endtime
        OPTIONAL MATCH (user)-[:HAS_DEPARTMENT]->(department:DEPARTMENT)
        OPTIONAL MATCH (app) - [has_app_category:HAS_APP_CATEGORY] - (app_category:APP_CATEGORY)
        OPTIONAL MATCH (user)-[:BELONGS_TO]->(group:GROUP {userDefined: true})
        OPTIONAL MATCH (tenant:TENANT {id: $tenant})-[app_settings:HAS_APP_SETTINGS]-(app)
        OPTIONAL MATCH (tenant:TENANT {id: $tenant})-[:HAS_INSTANCE]-(instance:INSTANCE)-[has_idp:HAS_IDP]-(app:APPLICATION)
        WITH user, has_email, email, credsbased_account, account, app, app_category, app_settings, group, department,scope,grant,instance,has_idp          
        RETURN DISTINCT
          user.id AS userId,
          user.displayName AS userName,
          user.mail AS userMail,
          user.accountEnabled AS userAccountEnabled,
          department.name AS userDepartment,
          user.tenant AS TENANT,
          user.subscriber AS SUBSCRIBER,
          app.id_ AS appId,
          COALESCE(CASE WHEN NOT app.name IN ['', '-'] THEN app.name ELSE NULL END, app.domain) AS appName,
          app.Url AS appUrl,
          app.domain AS appDomain,
          COLLECT(app_category.name) AS appCategory,
          COLLECT(scope.id) AS scope,
          COALESCE(app_settings.criticality, app.criticality, 'NOT SET') AS appCriticality,
          scope.severity AS scopeSeverity,
          grant.consentBy AS consentBy,
          account.id AS userAppAccount,
          credsbased_account.context_id as CONTEXTID,
          credsbased_account.last_access_time as EVENTTIME"
config:
  expression: "def fn(message): return True if message.get('userName') else False "
  type: finding
  subtype: status
  status: open
  sla: 1W
  entity: userName
  entitytype: user
  tags:
    - insecure_behavior
  sourceofalert: Quilr
  template: "Received an alert for the User: ${userName} on Application: ${appName}"
  artifacts: 
     - type: "ACCOUNT"
       property: "id"
       value: "$userAppAccount"
       artifactproperties: 
        artifactValue: $userName
        displayInUI: enabled
        artifactKey: "Account"
     - type: "APPLICATION" 
       context: "global" 
       property: id_
       value: $appId
       artifactproperties: 
        artifactValue: $appName
        displayInUI: enabled
        artifactKey: "Application"
     - type: "SCOPE"
       property: "id"
       value: "$scope"
       artifactproperties: 
        artifactValue: $scope
        displayInUI: enabled
        artifactKey: "Scope Used"
#     - type: "App Criticality"
#       property: "criticality"
#       value: "$appCriticality"
#       artifactproperties:
#        artifactValue: $appCriticality
#        displayInUI: enabled
#        artifactKey: "Critical"
  properties:
      userId: $userId
      userName: $userName
      userMail: $userMail
      userAccountEnabled: $userAccountEnabled
      TENANT: $TENANT
      SUBSCRIBER: $SUBSCRIBER
      appName: $appName
      appUrl: $appUrl
      appId: $appId
      accountId: $userAppAccount
      appCategory: $appCategory 
      scope: $scope
      consentBy: $consentBy
      appDomain: $appDomain
      context_id: $CONTEXTID
      time: $EVENTTIME
lambda: ""