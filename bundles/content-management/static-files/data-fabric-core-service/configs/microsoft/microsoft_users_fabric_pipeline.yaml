id: d628e7aa-73fd-46a6-88df-33b06495b03a
name: graph-api-user-data
type: fabric
version: 1.0.12
trail:
  block: start
  dependson: []
  attempt:
    - block: get_refresh_token
      dependson: []
      attempt:
        - block: update_completion_to_25
          dependson: []
          attempt: []
          otherwise: []
          start: false
          end: false
        - block: send_token_to_vault
          dependson: []
          attempt: []
          otherwise: []
          start: false
          end: false
        - block: list_users
          dependson:
            - get_refresh_token
          attempt:
            - block: upload_profile_pic_to_blob
              dependson:
                - list_users
              attempt: []
              otherwise: []
              start: false
              end: false
            - block: get_mfa_data
              dependson: []
              attempt: []
              otherwise: []
              start: false
              end: false
            - block: get_manager_data
              dependson: []
              attempt:
                - block: get_user_groups_data
                  dependson: []
                  attempt:
                    - block: update_completion_to_50
                      dependson: []
                      attempt: []
                      otherwise: []
                      start: false
                      end: false
                    - block: merge_manager_data
                      dependson:
                        - get_manager_data
                        - get_user_groups_data
                      attempt:
                        - block: merge_groups_data
                          dependson:
                            - merge_manager_data
                          attempt:
                            - block: merge_mfa_data
                              dependson:
                                - merge_groups_data
                              attempt:
                                - block: update_completion_to_75
                                  dependson: []
                                  attempt: []
                                  otherwise: []
                                  start: false
                                  end: false
                                - block: get_role_data
                                  dependson:
                                    - merge_mfa_data
                                  attempt:
                                    - block: get_role_definition
                                      dependson:
                                        - get_role_data
                                      attempt:
                                        - block: merge_role_definition
                                          dependson:
                                            - get_role_definition
                                          attempt:
                                            - block: merge_role_data
                                              dependson:
                                                - merge_role_definition
                                              attempt:
                                                - block: publish_to_rawOutput
                                                  dependson: [merge_role_data]
                                                  attempt:
                                                    - block: update_completion_to_100
                                                      dependson:
                                                        - publish_to_rawOutput
                                                      attempt:
                                                        - block: end
                                                          dependson: []
                                                          attempt: []
                                                          otherwise: []
                                                          start: false
                                                          end: true
                                                      otherwise:
                                                        - block: end
                                                          dependson: []
                                                          attempt: []
                                                          otherwise: []
                                                          start: false
                                                          end: true
                                                      start: false
                                                      end: false
                                                  otherwise: []
                                                  start: false
                                                  end: false
                                              otherwise:  []
                                              start: false
                                              end: false
                                          otherwise: []
                                          start: false
                                          end: false
                                      otherwise: []
                                      start: false
                                      end: false
                                  otherwise: []
                                  start: false
                                  end: false
                              otherwise: []
                              start: false
                              end: false
                          otherwise: []
                          start: false
                          end: false
                      otherwise: []
                      start: false
                      end: false
                  otherwise: []
                  start: false
                  end: false
              otherwise: []
              start: false
              end: false
          otherwise: []
          start: false
          end: false
      otherwise: []
      start: false
      end: false
  otherwise:
    - block: end
      dependson: []
      attempt: []
      otherwise: []
      start: false
      end: true
  start: true
  end: false
blocks:
  - name: start
    type: start
    config: {}
  - name: end
    type: end
    config: {}
  - name: get_refresh_token
    type: receiver
    config:
      type: rest
      uri: https://login.microsoftonline.com/common/oauth2/v2.0/token
      method: GET
      headers: {}
      body:
        grant_type: refresh_token
        client_id: $.env.client_id
        client_secret: $.env.client_secret
        scope: https://graph.microsoft.com/.default
        refresh_token: $.credential.token.refreshToken
      extract: null
      pagination: null
      paginationplacement: null
  - name: send_token_to_vault
    type: sender
    config:
      type: vault
      credential_type: token
      subscriber: $.context.subscriber
      tenant: $.context.tenant
      userid: $.context.context.userid
      facade:
        accessToken: $.block.get_refresh_token.output.response.response.access_token
        refreshToken: $.block.get_refresh_token.output.response.response.refresh_token
  - name: list_users
    type: receiver
    config:
      type: rest
      uri: https://graph.microsoft.com/v1.0/users?$select=id,otherMails,employeeId,employeeType,displayName,mail,accountEnabled,city,companyName,employeeHireDate,country,createdDateTime,deletedDateTime,businessPhones,department,employeeLeaveDateTime,givenName,identities,jobTitle,lastPasswordChangeDateTime,mobilePhone,mailNickname,officeLocation,passwordPolicies,passwordProfile,preferredLanguage,proxyAddresses,securityIdentifier,state,streetAddress,surname,userPrincipalName,userType
      method: GET
      headers:
        Authorization: Bearer $.block.get_refresh_token.output.response.response.access_token
      body: {}
      extract: value
      pagination: null
      paginationplacement: null
  - name: get_mfa_data
    type: receiver
    config:
      type: rest
      uri: https://graph.microsoft.com/beta/reports/credentialUserRegistrationDetails
      method: GET
      headers:
        Authorization: Bearer $.block.get_refresh_token.output.response.response.access_token
      body: {}
      extract: value
      pagination: null
      paginationplacement: null
  - name: get_manager_data
    type: receiver
    config:
      type: rest
      uri: https://graph.microsoft.com/v1.0/users/$.input.using.id/manager
      method: GET
      headers:
        Authorization: Bearer $.block.get_refresh_token.output.response.response.access_token
      body:
        userid: $.input.using.id
      foreach: $.block.list_users.output.response.response[*]
      extract: null
      pagination: null
      paginationplacement: null
  - name: upload_profile_pic_to_blob
    type: sender
    config:
      type: blob
      foreach: $.block.list_users.output.response.response[*]
      method: GET
      fileurl: https://graph.microsoft.com/v1.0/users/$.input.using.id/photo/$value
      token: Bearer $.block.get_refresh_token.output.response.response.access_token
      blobname: profile/pic/$.context.tenant/$.input.using.id
      blobfileextension: ".png"
  - name: get_role_definition
    type: receiver
    config:
      type: rest
      uri: https://graph.microsoft.com/beta/roleManagement/directory/roleDefinitions?$select=id,isBuiltIn,isEnabled,isPrivileged,displayName
      method: GET 
      headers:
        Authorization: Bearer $.block.get_refresh_token.output.response.response.access_token
      body: {}
      extract: value
      pagination: null
      paginationplacement: null
  - name: get_user_groups_data
    type: receiver
    config:
      type: rest
      uri: https://graph.microsoft.com/v1.0/users/$.input.using.id/transitiveMemberOf/microsoft.graph.group?$count=true&$select=id,deletedDateTime,createdDateTime,creationOptions,description,displayName,expirationDateTime,groupTypes,isAssignableToRole,mail,mailEnabled,mailNickname,renewedDateTime,securityEnabled,securityIdentifier,visibility
      method: GET
      headers:
        Authorization: Bearer $.block.get_refresh_token.output.response.response.access_token
      body:
        userid: $.input.using.id
      foreach: $.block.list_users.output.response.response[*]
      extract: value
      pagination: null
      paginationplacement: null
  - name: get_role_data
    type: receiver
    config:
      type: rest
      uri: https://graph.microsoft.com/v1.0/users/$.input.using.id/transitiveMemberOf/microsoft.graph.directoryRole
      method: GET
      headers:
        Authorization: Bearer $.block.get_refresh_token.output.response.response.access_token
      body:
        userid: $.input.using.id
      foreach: $.block.list_users.output.response.response[*]
      extract: value
      pagination: null
      paginationplacement: null
  - name: merge_manager_data
    type: util
    config:
      type: merge
      primary: $.block.list_users.output.response.response
      secondary: $.block.get_manager_data.output.response
      pickfrom: response
      sinkto: manager
      condition: "$.primary.id == $.secondary.body.userid && $.secondary.response.error.code == null"
  - name: merge_groups_data
    type: util
    config:
      type: merge
      primary: $.block.merge_manager_data.output.response.response
      secondary: $.block.get_user_groups_data.output.response
      pickfrom: response
      sinkto: groups
      condition: "$.primary.id == $.secondary.body.userid"
  - name: merge_role_definition
    type: util
    config:
      type: merge
      foreach: $.block.get_role_data.output.response[*]
      primary: $.input.using.response
      secondary: $.block.get_role_definition.output.response.response
      pickfrom: null
      sinkto: role_definition
      condition: "$.primary.roleTemplateId == $.secondary.id"
      passprimarycontext: $.input.using
  - name: merge_mfa_data
    type: util
    config:
      type: merge
      primary: $.block.merge_groups_data.output.response.response
      secondary: $.block.get_mfa_data.output.response.response
      pickfrom: null
      sinkto: registrationDetails
      condition: "$.primary.mail == $.secondary.userPrincipalName"
  - name: merge_role_data
    type: util
    config:
      type: merge
      primary: $.block.merge_mfa_data.output.response.response
      secondary: $.block.merge_role_definition.output.response
      pickfrom: response
      sinkto: roles
      condition: "$.primary.id == $.secondary.primarycontext.body.userid"
  - name: publish_to_rawOutput
    type: sender
    config:
      type: kafka
      topic: rawOutput
      facade:
        relation_type: HAS_IDP
        domain: login.microsoftonline.com
        instance_id: $.context.context.instanceid
        name: Active Directory Users Connector
        description: Azure AD Connector Configuration
        type: users
        vendor: Microsoft
        product: microsoft.graph
        subProduct: /v1.0/users
        data: $.input.using
        subscriber: $.context.subscriber
        tenant: $.context.tenant
      foreach: $.block.merge_role_data.output.response.response[*]
  - name: update_completion_to_25
    type: receiver
    config:
      type: rest
      uri: http://content-tracking-service:9037/pipelines/$.context.context.pipelineid/update
      method: POST
      headers:
        Internal: true
      body:
        output :
          completed_percentage: 25
          executed_blocks : 1
      extract: null
      pagination: null
      paginationplacement: null
  - name: update_completion_to_50
    type: receiver
    config:
      type: rest
      uri: http://content-tracking-service:9037/pipelines/$.context.context.pipelineid/update
      method: POST
      headers:
        Internal: true
      body:
        output :
          completed_percentage: 50
          executed_blocks : 7
      extract: null
      pagination: null
      paginationplacement: null
  - name: update_completion_to_75
    type: receiver
    config:
      type: rest
      uri: http://content-tracking-service:9037/pipelines/$.context.context.pipelineid/update
      method: POST
      headers:
        Internal: true
      body:
        output :
          completed_percentage: 75
          executed_blocks : 11
      extract: null
      pagination: null
      paginationplacement: null
  - name: update_completion_to_100
    type: receiver
    config:
      type: rest
      uri: http://content-tracking-service:9037/pipelines/$.context.context.pipelineid/update
      method: POST
      headers:
        Internal: true
      body:
        output :
          completed_percentage: 100
          executed_blocks : 20
          is_completed : true
      extract: null
      pagination: null
      paginationplacement: null