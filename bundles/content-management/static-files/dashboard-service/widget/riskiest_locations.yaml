widget_id: 24fb0fb6-5831-46d8-8652-485102406e36
template_id: RiskiestLocations
active: true
title: Riskiest Locations
components:
  - name: Riskiest Locations
    type: table
    data_source_type: knowledgegraph
    lambda: |
      def fn(client):
        data_result = client.fetch_data(
            query="MATCH (user:USER)-[r:LOCATED_AT]-(loc:OFFICE_LOCATION)"
                  " WHERE loc.score IS NOT NULL AND user.subscriber = $subscriber AND user.tenant = $tenant"
                  " WITH user,loc"
                  " MATCH (user)-[:HAS_EMAIL]-(e:EMAIL:PRIMARY)"
                  " MATCH (e)-[:CREDSBASED_ACCOUNT]->(acc:ACCOUNT)"
                  " RETURN loc.name AS location,"
                  " count(distinct acc.id) as totalUsers,"
                  " toInteger(loc.score) as riskScore"
        )
        if data_result and isinstance(data_result, list) and data_result[0]:
            total_record_count = 1
            formatted_data = {"data": data_result,"total_record_count":total_record_count}
            return formatted_data
        else:
            # Handle case where data_result is empty or doesn't contain expected structure
            formatted_data = {
                "data": [],
                "total_record_count": 0
            }
            return formatted_data
version: 1.0.41