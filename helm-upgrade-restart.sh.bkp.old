#!/bin/bash
set -e

NAMESPACE="quilr"
WAIT_TIMEOUT=30

echo "ğŸš€ Helm upgrade + restart tool for selected services"
echo "Namespace: $NAMESPACE"
echo "================================================================="

# Use arguments if provided; otherwise prompt
if [[ $# -gt 0 ]]; then
  SERVICES=("$@")
  echo "ğŸ“‹ Services provided via arguments:"
  printf "  - %s\n" "${SERVICES[@]}"
else
  echo "ğŸ‘‰ Enter service/chart names (space or newline separated)."
  echo "ğŸ‘‰ Press ENTER, then CTRL+D when done."
  mapfile -t SERVICES
fi

echo
echo "================================================================="

for svc in "${SERVICES[@]}"; do
  svc=$(echo "$svc" | xargs)
  [[ -z "$svc" ]] && continue

  echo "ğŸ“¦ Processing: $svc"
  if [[ -d "$svc" && -f "$svc/Chart.yaml" ]]; then
    echo "ğŸ”§ Running helm upgrade..."
    if helm upgrade --install "$svc" "./$svc" -n "$NAMESPACE" --create-namespace; then
      echo "âœ… Helm upgrade succeeded for $svc"
    else
      echo "âŒ Helm upgrade failed for $svc â€” skipping restart."
      continue
    fi

    # Handle CronJobs gracefully â€” no restart needed
    if kubectl get cronjob "$svc" -n "$NAMESPACE" &>/dev/null; then
      echo "â­ Skipping restart for $svc (detected as CronJob)"
      continue
    fi

    # Restart only if a Deployment exists
    if kubectl get deploy "$svc" -n "$NAMESPACE" &>/dev/null; then
      echo "ğŸ” Restarting deployment for $svc..."
      kubectl rollout restart deploy "$svc" -n "$NAMESPACE"

      echo "â³ Waiting up to $WAIT_TIMEOUT seconds for pods to become Ready..."
      if kubectl rollout status deploy/"$svc" -n "$NAMESPACE" --timeout=${WAIT_TIMEOUT}s; then
        echo "âœ… $svc is running successfully."
      else
        echo "âš ï¸  $svc pods not ready in $WAIT_TIMEOUTs â€” showing current pod status..."
        kubectl get pods -n "$NAMESPACE" -l "app=$svc" || true
      fi
    else
      echo "âš ï¸  No deployment found for $svc â€” skipping restart."
    fi
  else
    echo "âš ï¸  Skipping $svc â€” Chart.yaml not found."
  fi
  echo "-----------------------------------------------------------------"
done

# Final readiness summary (using "app in (...)" selector)
echo
echo "ğŸ“Š Final readiness summary for all updated services:"
echo "================================================================="

DEPLOY_SERVICES=()
for svc in "${SERVICES[@]}"; do
  if kubectl get deploy "$svc" -n "$NAMESPACE" &>/dev/null; then
    DEPLOY_SERVICES+=("$svc")
  fi
done

if [[ ${#DEPLOY_SERVICES[@]} -gt 0 ]]; then
  svc_list=$(IFS=,; echo "${DEPLOY_SERVICES[*]}")
  echo "ğŸ” Checking pods with: app in (${svc_list})"
  kubectl get pods -A -l "app in (${svc_list})"
else
  echo "âš ï¸  No deployments found among the given services."
fi

echo
echo "ğŸ‰ Done â€” upgrade, restart, and verification complete."