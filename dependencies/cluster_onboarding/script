Start snowflake-ingestion-service listener
---------------------------------------------------
curl --request GET \
  --url https://quilr.axisbank.com/bff/sf-ingestion/api/kafka/registry/list \
  --header 'Internal: true' \
  --header 'User-Agent: insomnia/9.2.0' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI

curl --request POST \
  --url 'https://quilr.axisbank.com/bff/sf-ingestion/api/kafka/registry/create?topic=alertMeta&table=KAFKA_CONNECT.SNOWDATA_SCHEMA.ALERTMETA&postgres=true' \
  --header 'Internal: true' \
  --header 'User-Agent: insomnia/9.2.0' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI


curl --request POST \
  --url 'https://quilr.axisbank.com/bff/sf-ingestion/api/kafka/registry/create?topic=transformedOutput&table=KAFKA_CONNECT.SNOWDATA_SCHEMA.TRANSFORMEDDATA&postgres=true' \
  --header 'Internal: true' \
  --header 'User-Agent: insomnia/9.2.0' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI


curl --request POST \
  --url 'https://quilr.axisbank.com/bff/sf-ingestion/api/kafka/registry/create?topic=behaviourProfile&table=KAFKA_CONNECT.SNOWDATA_SCHEMA.BEHAVIOURPROFILE&postgres=true' \
  --header 'Internal: true' \
  --header 'User-Agent: insomnia/9.2.0' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI  

curl --request POST \
  --url 'https://quilr.axisbank.com/bff/sf-ingestion/api/kafka/registry/create?topic=alertClassify&table=KAFKA_CONNECT.SNOWDATA_SCHEMA.ALERTCLASSIFY&postgres=true' \
  --header 'Internal: true' \
  --header 'User-Agent: insomnia/9.2.0' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI  

curl --request POST \
  --url 'https://quilr.axisbank.com/bff/sf-ingestion/api/kafka/registry/create?topic=postureProfile&table=kafka_connect.snowdata_schema.postureprofile&postgres=true' \
  --header 'Internal: true' \
  --header 'User-Agent: insomnia/9.2.0' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI  

curl --request POST \
  --url 'https://quilr.axisbank.com/bff/sf-ingestion/api/kafka/registry/create?topic=userScoreSnapshot&table=kafka_connect.snowdata_schema.userScoreSnapshot&postgres=true' \
  --header 'Internal: true' \
  --header 'User-Agent: insomnia/9.2.0' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI 

Ingest global-apps into graphdb(API: app db full-sync trigger)
------------------------------------------------------------------

curl --request POST \
  --url https://quilr.axisbank.com/bff/app-sync-local/full-sync \
  --header 'User-Agent: insomnia/10.2.0' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI


Onboard the customer
--------------------------------
curl --location 'https://quilr.axisbank.com/bff/auth/auth/onboard' \
--header 'accept: application/json' \
--header 'Authorization: 6788' \
--header 'Content-Type: application/json' \
--data-raw '
{                              
    "firstname":"Rishab",
    "lastname":"Zodage",
    "email":"rishab.zodage@iifl.com",
    "vendor":"microsoft"                                
}'

Get the subscriber id
---------------------------

IN POSTGRES DEVELOPMENT DB UNDER SUBSCRIBERCONNECTIONCONFIG TABLE

Check schema-registry config and insert entries in subscriberconnectionconfig table
--------------------------------------------------------------------------------------

curl --request POST \
  --url https://quilr.axisbank.com/bff/schema-registry/db/connection/onboard \
  --header 'Content-Type: application/json' \
  --header 'User-Agent: insomnia/8.5.1' \
  --cookie connect.sid=s%253APj5HScuipHz0KRT6oY6rutb9oYTJBVyY.lX6%252B6VTGHh8U1SpqLpWgCx2Jmmo45weG0fgPuP%252FuH%252BI \
  --data '{
 "subscriber": "1b88c4a4-257c-4f60-83ab-604cb5ba2c29"
}'

Get the tenant-id from tenant table in quilr_auth db
--------------------------------------------------------
\connect quilr_auth;

select * from tenant

create internal user entry in db to monitor UI 
--------------------------------------------------------
\connect quilr_auth;

INSERT INTO "user"("firstname","lastname","username","email","password","subscriberId","tenantIds","roleIds","groupIds","status","verification_status","createdby","updatedby","createdon","updatedon","deletedAt","accountType","emailSent","lastLogin")
VALUES
(E'Monitor',E'Quilr',E'monitor',E'monitor-iifl@quilr.ai',E'$2a$10$vC92Bwb3Y.xvexKgV/yP1uqqNGPXQvufxwU5/cR56ksLFEh11557u',E'1b88c4a4-257c-4f60-83ab-604cb5ba2c29',E'{6516562c-0372-4704-8858-978d27ca1f24}',E'{81569d9b-65e4-4cc1-8668-10c373dde677}',E'{12eade82-5018-4ac3-8972-53bcb447712e}',E'active',E'unverified',E'Quilr-Omega',E'Quilr-Omega',E'2024-11-22 10:55:10.070456',E'2025-05-26 13:54:38.968692',NULL,E'credentials',FALSE,1748267678973);


https://quilr.axisbank.com/en/internal-login
user:
password: 

Enable AI-AXIS:
-----------------------
UPDATE tenant SET license_config = '{"ai_axis_enabled":true}' WHERE id = '6516562c-0372-4704-8858-978d27calf24';

manually create TENANT node in graph for onboarded customer
----------------------------------------------------------------

 kubectl exec -it quilr-neo4j-0 -n quilr --  cypher-shell -u neo4j -p 'QUIuI23L*R$#%#&457Ip'

{
  "tenant": '6516562c-0372-4704-8858-978d27calf24',
  "subscriber": '1b88c4a4-257c-4f60-83ab-604cb5ba2c29',
  "tenant_name": 'IIFL'
}

MERGE (t:TENANT {id: $tenant})
ON CREATE SET t.subscriber = $subscriber,
    t.tenant = $tenant,
    t.name = $tenant_name,
    t.timestamp = timestamp()
RETURN t

Populate indexes in Neo4j
----------------------------------

//CREATE INDEX
CREATE INDEX appIdSearch IF NOT EXISTS FOR (n:APPLICATION) ON (n.id_);
CREATE INDEX appAliasesSearch IF NOT EXISTS FOR (n:APPLICATION) ON (n.aliases);
CREATE INDEX appDomainSearch IF NOT EXISTS FOR (n:APPLICATION) ON (n.domain);
CREATE FULLTEXT INDEX appSearch IF NOT EXISTS FOR (n:APPLICATION) ON EACH [n.domain, n.name];
CREATE FULLTEXT INDEX userSearch IF NOT EXISTS FOR (n:USER) ON EACH [n.displayName, n.jobTitle];
CREATE INDEX userIdSearch IF NOT EXISTS FOR (n:USER) ON (n.id);
CREATE INDEX userTenantSearch IF NOT EXISTS FOR (n:USER) ON (n.subscriber, n.tenant);
CREATE INDEX userMailSearch IF NOT EXISTS FOR (n:USER) ON (n.mail);
CREATE INDEX emailTenantSearch IF NOT EXISTS FOR (n:EMAIL) ON (n.subscriber, n.tenant);
CREATE INDEX accountIdSearch IF NOT EXISTS FOR (n:ACCOUNT) ON (n.id);
CREATE INDEX accountEmailSearch IF NOT EXISTS FOR (n:ACCOUNT) ON (n.email);
CREATE INDEX accountTenantSearch IF NOT EXISTS FOR (n:ACCOUNT) ON (n.subscriber, n.tenant);
CREATE INDEX findingIdSearch IF NOT EXISTS FOR (n:FINDING) ON (n.id);
CREATE INDEX findingTenantSearch IF NOT EXISTS FOR (n:FINDING) ON (n.subscriber, n.tenant);
CREATE FULLTEXT INDEX departmentSearch IF NOT EXISTS FOR (n:DEPARTMENT) ON EACH [n.name];
CREATE INDEX groupUserDefinedSearch IF NOT EXISTS FOR (n:GROUP) ON (n.userDefined);
CREATE FULLTEXT INDEX groupSearch IF NOT EXISTS FOR (n:GROUP) ON EACH [n.displayName];
CREATE FULLTEXT INDEX appCategorySearch IF NOT EXISTS FOR (n:APP_CATEGORY) ON EACH [n.name];
CREATE INDEX credsbasedAccountLastAccessed IF NOT EXISTS FOR ()-[r:CREDSBASED_ACCOUNT]->() ON r.last_access_time;
CREATE INDEX oauthAccountLastAccessed IF NOT EXISTS FOR ()-[r:OAUTH_ACCOUNT]->() ON r.last_access_time;
CREATE INDEX samlAccountLastAccessed IF NOT EXISTS FOR ()-[r:SAML_ACCOUNT]->() ON r.last_access_time;
CREATE INDEX guestAccountLastAccessed IF NOT EXISTS FOR ()-[r:GUEST_ACCOUNT]->() ON r.last_access_time;
CREATE INDEX behaviorIdSearch IF NOT EXISTS FOR (n:BEHAVIOR) ON (n.id);
CREATE INDEX findingTimestampSearch IF NOT EXISTS FOR (n:FINDING) ON (n.timestamp);
CREATE INDEX findingHistoryTimestampSearch IF NOT EXISTS FOR (n:FINDING_HISTORY) ON (n.timestamp);
CREATE INDEX tenantIdSearch IF NOT EXISTS FOR (n:TENANT) ON (n.id);
CREATE INDEX emailIdSearch IF NOT EXISTS FOR (n:EMAIL) ON (n.id);
CREATE INDEX actionIdSearch IF NOT EXISTS FOR (n:ACTION) ON (n.id);
CREATE INDEX outcomeIdSearch IF NOT EXISTS FOR (n:OUTCOME) ON (n.id);
CREATE INDEX whitelistedforTenantSearch IF NOT EXISTS FOR ()-[r:WHITELISTED_FOR]-() ON (r.tenant);
CREATE INDEX usingAppTimestampSearch IF NOT EXISTS FOR ()-[r:USING_APP]-() ON (r.timestamp);
CREATE INDEX hasAppSettingsCriticalitySearch IF NOT EXISTS FOR ()-[r:HAS_APP_SETTINGS]-() ON (r.criticality);
CREATE INDEX hasAppSettingsApprovalStatusSearch IF NOT EXISTS FOR ()-[r:HAS_APP_SETTINGS]-() ON (r.approval_status);
CREATE INDEX scopeSeveritySearch IF NOT EXISTS FOR (n:SCOPE) ON (n.severity);

Create indexes in db table: templates, execution_controls -postgress internal Db - quilr
---------------------------------------------------------------------------------------------

CREATE UNIQUE INDEX idx_unique_active_controls 
ON execution_controls (slug, is_active, subscriber, tenant)
WHERE is_active = true;

CREATE UNIQUE INDEX idx_unique_active_template 
ON templates (slug, type, channel, is_active, subscriber, tenant)
WHERE is_active = true; 

data_model View creation
--------------------------

create view data_model AS
select om.category_name as modelname, rs.tenant_id as tenant from dlp_config_risks_oob_metadata as om, dlp_config_risk_states as rs where om.risk_type='data' and om.category_id = rs.category
UNION select name as modelname, tenant_id as tenant from dlp_config_configs where metadata::jsonb->>'category'='Data Risks';

Enable Data-definition
-------------------------------

Need to add the tenant id below curl request

curl --location 'https://platform.quilr.ai/bff/data-definitions/add_tenant' \
--header 'accept: application/json' \
--header 'Tenant: 6516562c-0372-4704-8858-978d27calf24' \
--header 'Authorization: 6788' \
--header 'Content-Type: application/json' \
--data '{}'
