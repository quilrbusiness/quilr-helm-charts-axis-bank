kubectl create configmap quilr-clickhouse-initdb-scripts \
  --from-file=init-scripts/ \
  -n quilr
kubectl create configmap quilr-clickhouse-initdb-scripts-devops-378 \
  --from-file=init-scripts/ \
  -n quilr

helm upgrade --install quilr oci://registry-1.docker.io/bitnamicharts/clickhouse \
  -f clickhouse-values.yaml \
  -n quilr

kubectl patch svc quilr-clickhouse  \
  -n quilr \
  -p '{"metadata":{"annotations":{"service.beta.kubernetes.io/azure-load-balancer-internal":"true"}}}'

 kubectl patch svc quilr-clickhouse  \
  -n quilr \
  -p '{"spec":{"type": "LoadBalancer"}}' 

kubectl logs -f quilr-clickhouse-shard0-0 -n quilr

kubectl exec -it quilr-clickhouse-shard0-0 -n quilr -- bash
cd /docker-entrypoint-initdb.d


clickhouse-client \
  -h localhost \
  -u quilradmin \
  --password 'QU1lr$F345#we' \
  --multiquery < <(cat 01_apps_db.sql 02_app_tenant_settings.sql 03_users.sql 04_raw_alert_logs.sql 05_raw_alert_responses.sql 06_enriched_events.sql 07_quilr_alert_events.sql 08_quilr_interaction_logs.sql 09_quilr_alert_status.sql 10_quilr_alert_action.sql)

clickhouse-client -h localhost -u quilradmin --password 'QU1lr$F345#we' --query="SHOW TABLES"

clickhouse-client -h localhost -u quilradmin --password 'QU1lr$F345#we' --multiquery < <(cat dml_clickhouse.sql)

# Request to open port number 8123 on UI for clickhouse svc
#   http://<LB IP Address>:8123/
#   username: quilradmin
#   password: "QU1lr$F345#we"
#--- loading of init scripts needs to be verified ----

#vault-secrets-insertion-for-clickhouse-db

export VAULT_ADDR="https://10.8.133.8:8200"
export VAULT_TOKEN="hvs.vyFRb35JYPK3eBuWdmFT1LC7"
export VAULT_SKIP_VERIFY=true

#To verify if you are able to get secrets

vault kv get secret/quilr-common-config-vault 

vault kv patch secret/quilr-common-config-vault \
  DW_NAME="clickhouse" \
  DW_PASSWORD="QU1lr$F345#we" \
  DW_URL="jdbc:ch://quilr-clickhouse.quilr.svc.cluster.local:8123/default" \
  DW_USER="quilradmin" 

#verify the added secrets

vault kv get secret/quilr-common-config-vault | grep -E 'DW_NAME|DW_PASSWORD|DW_URL|DW_USER'
