apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.quilr.appname }}
  namespace: {{ .Values.namespace | default "quilr" }}
  labels:
    app: {{ .Values.quilr.appname }}
spec:
  schedule: {{ .Values.cronjob.schedule | quote }}
  concurrencyPolicy: {{ .Values.cronjob.concurrencyPolicy }}
  successfulJobsHistoryLimit: 1 
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      activeDeadlineSeconds: {{ .Values.cronjob.activeDeadlineSeconds }}
      ttlSecondsAfterFinished: null
      backoffLimit: {{ .Values.cronjob.backoffLimit }}
      completions: 1
      parallelism: 1
      template:
        metadata:
          labels:
            app: {{ .Values.quilr.appname }}
          annotations:
            vault.security.banzaicloud.io/vault-addr: "{{ .Values.vault.addr }}"
            vault.security.banzaicloud.io/vault-env-passthrough: "VAULT_ADDR,VAULT_TOKEN"
            vault.security.banzaicloud.io/vault-role: "{{ .Values.vault.role }}"
            vault.security.banzaicloud.io/vault-skip-verify: "true"
            vault.security.banzaicloud.io/vault-agent: "true"
            vault.security.banzaicloud.io/vault-path: "{{ .Values.vault.path }}"
        spec:
          volumes:
            - name: agent-secrets
              emptyDir: {}
      initContainers:
        - name: wait-for-vault
          image: quilrdev.azurecr.io/bitnamilegacy/quilr-tp:curl-8.5.0
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              echo "Waiting for Vault at {{ .Values.vault.addr }}..."
              until curl -k -sSf {{ .Values.vault.addr }}/v1/sys/health; do
                echo "Vault not ready, retrying in 5s..."
                sleep 5
              done
              echo "Vault is ready!"
          containers:
            - name: {{ .Values.quilr.appname }}
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              command: ["Fabric"]
              env:
                - name: VAULT_TOKEN
                  value: vault:secret/data/quilr-common-config-vault#VAULT_TOKEN
                - name: PG_USER
                  value: vault:secret/data/quilr-common-config-vault#PG_USER
                - name: PG_PASSWORD
                  value: vault:secret/data/quilr-common-config-vault#PG_PASSWORD
                - name: PG_HOST
                  value: vault:secret/data/quilr-common-config-vault#PG_HOST
                - name: OAUTH_CLIENT_ID
                  value: vault:secret/data/quilr-common-config-vault#OAUTH_CLIENT_ID
                - name: OAUTH_CLIENT_SECRET
                  value: vault:secret/data/quilr-common-config-vault#OAUTH_CLIENT_SECRET
                # - name: STORAGE_CONNECTION_STRING
                #   value: vault:secret/data/quilr-common-config-vault#STORAGE_CONNECTION_STRING
                - name: REDIS_PASSWORD
                  value: vault:secret/data/quilr-common-config-vault#REDIS_PASSWORD
                - name: DW_PASSWORD
                  value: vault:secret/data/quilr-common-config-vault#DW_PASSWORD  
              envFrom:
                - configMapRef:
                    name: quilr-common-config
                - configMapRef:
                    name: {{ .Values.quilr.appname }}-configmap
          imagePullSecrets:
            - name: acr-secret
          restartPolicy: OnFailure
